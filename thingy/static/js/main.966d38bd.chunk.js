(this.webpackJsonplitegraph_test=this.webpackJsonplitegraph_test||[]).push([[0],{55:function(t,e,n){t.exports=n(77)},61:function(t,e,n){},74:function(t,e,n){(function(t){!function(e){var n=e.LiteGraph={VERSION:.4,CANVAS_GRID_SIZE:10,NODE_TITLE_HEIGHT:30,NODE_TITLE_TEXT_Y:20,NODE_SLOT_HEIGHT:20,NODE_WIDGET_HEIGHT:20,NODE_WIDTH:140,NODE_MIN_WIDTH:50,NODE_COLLAPSED_RADIUS:10,NODE_COLLAPSED_WIDTH:80,NODE_TITLE_COLOR:"#999",NODE_TEXT_SIZE:14,NODE_TEXT_COLOR:"#AAA",NODE_SUBTEXT_SIZE:12,NODE_DEFAULT_COLOR:"#333",NODE_DEFAULT_BGCOLOR:"#353535",NODE_DEFAULT_BOXCOLOR:"#666",NODE_DEFAULT_SHAPE:"box",DEFAULT_SHADOW_COLOR:"rgba(0,0,0,0.5)",DEFAULT_GROUP_FONT:24,WIDGET_BGCOLOR:"#222",WIDGET_OUTLINE_COLOR:"#666",WIDGET_TEXT_COLOR:"#DDD",WIDGET_SECONDARY_TEXT_COLOR:"#999",LINK_COLOR:"#9A9",EVENT_LINK_COLOR:"#A86",CONNECTING_LINK_COLOR:"#AFA",MAX_NUMBER_OF_NODES:1e3,DEFAULT_POSITION:[100,100],VALID_SHAPES:["default","box","round","card"],BOX_SHAPE:1,ROUND_SHAPE:2,CIRCLE_SHAPE:3,CARD_SHAPE:4,ARROW_SHAPE:5,INPUT:1,OUTPUT:2,EVENT:-1,ACTION:-1,ALWAYS:0,ON_EVENT:1,NEVER:2,ON_TRIGGER:3,UP:1,DOWN:2,LEFT:3,RIGHT:4,CENTER:5,STRAIGHT_LINK:0,LINEAR_LINK:1,SPLINE_LINK:2,NORMAL_TITLE:0,NO_TITLE:1,TRANSPARENT_TITLE:2,AUTOHIDE_TITLE:3,proxy:null,node_images_path:"",debug:!1,catch_exceptions:!0,throw_errors:!0,allow_scripts:!1,registered_node_types:{},node_types_by_file_extension:{},Nodes:{},searchbox_extras:{},registerNodeType:function(t,e){if(!e.prototype)throw"Cannot register a simple object, it must be a class with a prototype";e.type=t,n.debug&&console.log("Node registered: "+t);t.split("/");var i=e.name,s=t.lastIndexOf("/");if(e.category=t.substr(0,s),e.title||(e.title=i),e.prototype)for(var r in o.prototype)e.prototype[r]||(e.prototype[r]=o.prototype[r]);Object.hasOwnProperty(e.prototype,"shape")||Object.defineProperty(e.prototype,"shape",{set:function(t){switch(t){case"default":delete this._shape;break;case"box":this._shape=n.BOX_SHAPE;break;case"round":this._shape=n.ROUND_SHAPE;break;case"circle":this._shape=n.CIRCLE_SHAPE;break;case"card":this._shape=n.CARD_SHAPE;break;default:this._shape=t}},get:function(t){return this._shape},enumerable:!0});var a=this.registered_node_types[t];if(a&&console.log("replacing node type: "+t),this.registered_node_types[t]=e,e.constructor.name&&(this.Nodes[i]=e),n.onNodeTypeRegistered&&n.onNodeTypeRegistered(t,e),a&&n.onNodeTypeReplaced&&n.onNodeTypeReplaced(t,e,a),e.prototype.onPropertyChange&&console.warn("LiteGraph node class "+t+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),e.supported_extensions)for(var r in e.supported_extensions)this.node_types_by_file_extension[e.supported_extensions[r].toLowerCase()]=e},wrapFunctionAsNode:function(t,e,i,s,o){for(var r=Array(e.length),a="",l=n.getParameterNames(e),u=0;u<l.length;++u)a+="this.addInput('"+l[u]+"',"+(i&&i[u]?"'"+i[u]+"'":"0")+");\n";a+="this.addOutput('out',"+(s?"'"+s+"'":0)+");\n",o&&(a+="this.properties = "+JSON.stringify(o)+";\n");var h=Function(a);h.title=t.split("/").pop(),h.desc="Generated from "+e.name,h.prototype.onExecute=function(){for(var t=0;t<r.length;++t)r[t]=this.getInputData(t);var n=e.apply(this,r);this.setOutputData(0,n)},this.registerNodeType(t,h)},addNodeMethod:function(t,e){for(var n in o.prototype[t]=e,this.registered_node_types){var i=this.registered_node_types[n];i.prototype[t]&&(i.prototype["_"+t]=i.prototype[t]),i.prototype[t]=e}},createNode:function(t,e,i){var s=this.registered_node_types[t];if(!s)return n.debug&&console.log('GraphNode type "'+t+'" not registered.'),null;s.prototype;e=e||s.title||t;var o=null;if(n.catch_exceptions)try{o=new s(e)}catch(a){return console.error(a),null}else o=new s(e);if(o.type=t,!o.title&&e&&(o.title=e),o.properties||(o.properties={}),o.properties_info||(o.properties_info=[]),o.flags||(o.flags={}),o.size||(o.size=o.computeSize()),o.pos||(o.pos=n.DEFAULT_POSITION.concat()),o.mode||(o.mode=n.ALWAYS),i)for(var r in i)o[r]=i[r];return o},getNodeType:function(t){return this.registered_node_types[t]},getNodeTypesInCategory:function(t,e){var n=[];for(var i in this.registered_node_types){var s=this.registered_node_types[i];e&&s.filter&&s.filter!=e||(""==t?null==s.category&&n.push(s):s.category==t&&n.push(s))}return n},getNodeTypesCategories:function(t){var e={"":1};for(var n in this.registered_node_types){var i=this.registered_node_types[n];if(i.category&&!i.skip_list){if(t&&i.filter!=t)continue;e[i.category]=1}}var s=[];for(var n in e)s.push(n);return s},reloadNodes:function(t){var e=document.getElementsByTagName("script"),i=[];for(var s in e)i.push(e[s]);var o=document.getElementsByTagName("head")[0];for(var s in t=document.location.href+t,i){var r=i[s].src;if(r&&r.substr(0,t.length)==t)try{n.debug&&console.log("Reloading: "+r);var a=document.createElement("script");a.type="text/javascript",a.src=r,o.appendChild(a),o.removeChild(i[s])}catch(l){if(n.throw_errors)throw l;n.debug&&console.log("Error while reloading "+r)}}n.debug&&console.log("Nodes reloaded")},cloneObject:function(t,e){if(null==t)return null;var n=JSON.parse(JSON.stringify(t));if(!e)return n;for(var i in n)e[i]=n[i];return e},isValidConnection:function(t,e){if(!t||!e||t==e||t==n.EVENT&&e==n.ACTION)return!0;if(t=String(t),e=String(e),t=t.toLowerCase(),e=e.toLowerCase(),-1==t.indexOf(",")&&-1==e.indexOf(","))return t==e;for(var i=t.split(","),s=e.split(","),o=0;o<i.length;++o)for(var r=0;r<s.length;++r)if(i[o]==s[r])return!0;return!1},registerSearchboxExtra:function(t,e,n){this.searchbox_extras[e.toLowerCase()]={type:t,desc:e,data:n}}};function i(t){n.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),t&&this.configure(t)}function s(t,e,n,i,s,o){this.id=t,this.type=e,this.origin_id=n,this.origin_slot=i,this.target_id=s,this.target_slot=o,this._data=null,this._pos=new Float32Array(2)}function o(t){this._ctor(t)}function r(t){this._ctor(t)}function a(t,e){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,e||this.bindEvents(t))}function l(t,e,i){i=i||{},this.background_image="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=",t&&t.constructor===String&&(t=document.querySelector(t)),this.ds=new a,this.zoom_modify_alpha=!0,this.title_text_font=n.NODE_TEXT_SIZE+"px Arial",this.inner_text_font="normal "+n.NODE_SUBTEXT_SIZE+"px Arial",this.node_title_color=n.NODE_TITLE_COLOR,this.default_link_color=n.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.read_only=!1,this.render_only_selected=!0,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.allow_searchbox=!0,this.allow_reconnect_links=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!1,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=n.SPLINE_LINK,this.canvas_mouse=[0,0],this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],e&&e.attachCanvas(this),this.setCanvas(t),this.clear(),i.skip_render||this.startRendering(),this.autoresize=i.autoresize}"undefined"!=typeof performance?n.getTime=performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?n.getTime=Date.now.bind(Date):n.getTime="undefined"!=typeof t?function(){var e=t.hrtime();return.001*e[0]+1e-6*e[1]}:function(){return(new Date).getTime()},e.LGraph=n.LGraph=i,i.supported_types=["number","string","boolean"],i.prototype.getSupportedTypes=function(){return this.supported_types||i.supported_types},i.STATUS_STOPPED=1,i.STATUS_RUNNING=2,i.prototype.clear=function(){if(this.stop(),this.status=i.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes)for(var t=0;t<this._nodes.length;++t){var e=this._nodes[t];e.onRemoved&&e.onRemoved()}this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.vars={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")},i.prototype.attachCanvas=function(t){if(t.constructor!=l)throw"attachCanvas expects a LGraphCanvas instance";t.graph&&t.graph!=this&&t.graph.detachCanvas(t),t.graph=this,this.list_of_graphcanvas||(this.list_of_graphcanvas=[]),this.list_of_graphcanvas.push(t)},i.prototype.detachCanvas=function(t){if(this.list_of_graphcanvas){var e=this.list_of_graphcanvas.indexOf(t);-1!=e&&(t.graph=null,this.list_of_graphcanvas.splice(e,1))}},i.prototype.start=function(t){if(this.status!=i.STATUS_RUNNING){this.status=i.STATUS_RUNNING,this.onPlayEvent&&this.onPlayEvent(),this.sendEventToAllNodes("onStart"),this.starttime=n.getTime(),this.last_update_time=this.starttime;var e=this;if(0==(t=t||0)&&"undefined"!=typeof window&&window.requestAnimationFrame){this.execution_timer_id=-1,function t(){-1==e.execution_timer_id&&(window.requestAnimationFrame(t),e.runStep(1,!this.catch_errors))}()}else this.execution_timer_id=setInterval((function(){e.runStep(1,!this.catch_errors)}),t)}},i.prototype.stop=function(){this.status!=i.STATUS_STOPPED&&(this.status=i.STATUS_STOPPED,this.onStopEvent&&this.onStopEvent(),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))},i.prototype.runStep=function(t,e,i){t=t||1;var s=n.getTime();this.globaltime=.001*(s-this.starttime);var o=this._nodes_executable?this._nodes_executable:this._nodes;if(o){if(i=i||o.length,e){for(var r=0;r<t;r++){for(var a=0;a<i;++a){(l=o[a]).mode==n.ALWAYS&&l.onExecute&&l.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute()}else try{for(r=0;r<t;r++){for(a=0;a<i;++a){var l;(l=o[a]).mode==n.ALWAYS&&l.onExecute&&l.onExecute()}this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep&&this.onExecuteStep()}this.onAfterExecute&&this.onAfterExecute(),this.errors_in_execution=!1}catch(c){if(this.errors_in_execution=!0,n.throw_errors)throw c;n.debug&&console.log("Error during execution: "+c),this.stop()}var u=n.getTime(),h=u-s;0==h&&(h=1),this.execution_time=.001*h,this.globaltime+=.001*h,this.iteration+=1,this.elapsed_time=.001*(u-this.last_update_time),this.last_update_time=u}},i.prototype.updateExecutionOrder=function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var t=0;t<this._nodes_in_order.length;++t)this._nodes_in_order[t].onExecute&&this._nodes_executable.push(this._nodes_in_order[t])},i.prototype.computeExecutionOrder=function(t,e){for(var i=[],s=[],o={},r={},a={},l=0,u=this._nodes.length;l<u;++l){var h=this._nodes[l];if(!t||h.onExecute){o[h.id]=h;var c=0;if(h.inputs)for(var p=0,d=h.inputs.length;p<d;p++)h.inputs[p]&&null!=h.inputs[p].link&&(c+=1);0==c?(s.push(h),e&&(h._level=1)):(e&&(h._level=0),a[h.id]=c)}}for(;0!=s.length;){h=s.shift();if(i.push(h),delete o[h.id],h.outputs)for(l=0;l<h.outputs.length;l++){var g=h.outputs[l];if(null!=g&&null!=g.links&&0!=g.links.length)for(p=0;p<g.links.length;p++){var _=g.links[p],f=this.links[_];if(f&&!r[f.id]){var v=this.getNodeById(f.target_id);null!=v?(e&&(!v._level||v._level<=h._level)&&(v._level=h._level+1),r[f.id]=!0,a[v.id]-=1,0==a[v.id]&&s.push(v)):r[f.id]=!0}}}}for(var l in o)i.push(o[l]);i.length!=this._nodes.length&&n.debug&&console.warn("something went wrong, nodes missing");for(u=i.length,l=0;l<u;++l)i[l].order=l;i=i.sort((function(t,e){var n=t.constructor.priority||t.priority||0,i=e.constructor.priority||e.priority||0;return n==i?t.order-e.order:n-i}));for(l=0;l<u;++l)i[l].order=l;return i},i.prototype.getAncestors=function(t){for(var e=[],n=[t],i={};n.length;){var s=n.shift();if(s.inputs){i[s.id]||s==t||(i[s.id]=!0,e.push(s));for(var o=0;o<s.inputs.length;++o){var r=s.getInputNode(o);r&&-1==e.indexOf(r)&&n.push(r)}}}return e.sort((function(t,e){return t.order-e.order})),e},i.prototype.arrange=function(t){t=t||100;for(var e=this.computeExecutionOrder(!1,!0),i=[],s=0;s<e.length;++s){var o=(c=e[s])._level||1;i[o]||(i[o]=[]),i[o].push(c)}var r=t;for(s=0;s<i.length;++s){var a=i[s];if(a){for(var l=100,u=t+n.NODE_TITLE_HEIGHT,h=0;h<a.length;++h){var c;(c=a[h]).pos[0]=r,c.pos[1]=u,c.size[0]>l&&(l=c.size[0]),u+=c.size[1]+t+n.NODE_TITLE_HEIGHT}r+=l+t}}this.setDirtyCanvas(!0,!0)},i.prototype.getTime=function(){return this.globaltime},i.prototype.getFixedTime=function(){return this.fixedtime},i.prototype.getElapsedTime=function(){return this.elapsed_time},i.prototype.sendEventToAllNodes=function(t,e,i){i=i||n.ALWAYS;var s=this._nodes_in_order?this._nodes_in_order:this._nodes;if(s)for(var o=0,r=s.length;o<r;++o){var a=s[o];a.constructor!==n.Subgraph||"onExecute"==t?a[t]&&a.mode==i&&(void 0===e?a[t]():e&&e.constructor===Array?a[t].apply(a,e):a[t](e)):a.mode==i&&a.sendEventToAllNodes(t,e,i)}},i.prototype.sendActionToCanvas=function(t,e){if(this.list_of_graphcanvas)for(var n=0;n<this.list_of_graphcanvas.length;++n){var i=this.list_of_graphcanvas[n];i[t]&&i[t].apply(i,e)}},i.prototype.add=function(t,e){if(t){if(t.constructor===r)return this._groups.push(t),this.setDirtyCanvas(!0),this.change(),t.graph=this,void this._version++;if(-1!=t.id&&null!=this._nodes_by_id[t.id]&&(console.warn("LiteGraph: there is already a node with this ID, changing it"),t.id=++this.last_node_id),this._nodes.length>=n.MAX_NUMBER_OF_NODES)throw"LiteGraph: max number of nodes in a graph reached";return null==t.id||-1==t.id?t.id=++this.last_node_id:this.last_node_id<t.id&&(this.last_node_id=t.id),t.graph=this,this._version++,this._nodes.push(t),this._nodes_by_id[t.id]=t,t.onAdded&&t.onAdded(this),this.config.align_to_grid&&t.alignToGrid(),e||this.updateExecutionOrder(),this.onNodeAdded&&this.onNodeAdded(t),this.setDirtyCanvas(!0),this.change(),t}},i.prototype.remove=function(t){if(t.constructor===n.LGraphGroup){var e=this._groups.indexOf(t);return-1!=e&&this._groups.splice(e,1),t.graph=null,this._version++,this.setDirtyCanvas(!0,!0),void this.change()}if(null!=this._nodes_by_id[t.id]&&!t.ignore_remove){if(t.inputs)for(var i=0;i<t.inputs.length;i++){null!=(s=t.inputs[i]).link&&t.disconnectInput(i)}if(t.outputs)for(i=0;i<t.outputs.length;i++){var s;null!=(s=t.outputs[i]).links&&s.links.length&&t.disconnectOutput(i)}if(t.onRemoved&&t.onRemoved(),t.graph=null,this._version++,this.list_of_graphcanvas)for(i=0;i<this.list_of_graphcanvas.length;++i){var o=this.list_of_graphcanvas[i];o.selected_nodes[t.id]&&delete o.selected_nodes[t.id],o.node_dragged==t&&(o.node_dragged=null)}var r=this._nodes.indexOf(t);-1!=r&&this._nodes.splice(r,1),delete this._nodes_by_id[t.id],this.onNodeRemoved&&this.onNodeRemoved(t),this.setDirtyCanvas(!0,!0),this.change(),this.updateExecutionOrder()}},i.prototype.getNodeById=function(t){return null==t?null:this._nodes_by_id[t]},i.prototype.findNodesByClass=function(t,e){(e=e||[]).length=0;for(var n=0,i=this._nodes.length;n<i;++n)this._nodes[n].constructor===t&&e.push(this._nodes[n]);return e},i.prototype.findNodesByType=function(t,e){t=t.toLowerCase();(e=e||[]).length=0;for(var n=0,i=this._nodes.length;n<i;++n)this._nodes[n].type.toLowerCase()==t&&e.push(this._nodes[n]);return e},i.prototype.findNodeByTitle=function(t){for(var e=0,n=this._nodes.length;e<n;++e)if(this._nodes[e].title==t)return this._nodes[e];return null},i.prototype.findNodesByTitle=function(t){for(var e=[],n=0,i=this._nodes.length;n<i;++n)this._nodes[n].title==t&&e.push(this._nodes[n]);return e},i.prototype.getNodeOnPos=function(t,e,n,i){for(var s=(n=n||this._nodes).length-1;s>=0;s--){var o=n[s];if(o.isPointInside(t,e,i))return o}return null},i.prototype.getGroupOnPos=function(t,e){for(var n=this._groups.length-1;n>=0;n--){var i=this._groups[n];if(i.isPointInside(t,e,2,!0))return i}return null},i.prototype.checkNodeTypes=function(){for(var t=0;t<this._nodes.length;t++){var e=this._nodes[t],i=n.registered_node_types[e.type];if(e.constructor!=i){console.log("node being replaced by newer version: "+e.type);var s=n.createNode(e.type);!0,this._nodes[t]=s,s.configure(e.serialize()),s.graph=this,this._nodes_by_id[s.id]=s,e.inputs&&(s.inputs=e.inputs.concat()),e.outputs&&(s.outputs=e.outputs.concat())}}this.updateExecutionOrder()},i.prototype.onAction=function(t,e){this._input_nodes=this.findNodesByClass(n.GraphInput,this._input_nodes);for(var i=0;i<this._input_nodes.length;++i){var s=this._input_nodes[i];if(s.properties.name==t){s.onAction(t,e);break}}},i.prototype.trigger=function(t,e){this.onTrigger&&this.onTrigger(t,e)},i.prototype.addInput=function(t,e,n){this.inputs[t]||(this.inputs[t]={name:t,type:e,value:n},this._version++,this.onInputAdded&&this.onInputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange())},i.prototype.setInputData=function(t,e){var n=this.inputs[t];n&&(n.value=e)},i.prototype.getInputData=function(t){var e=this.inputs[t];return e?e.value:null},i.prototype.renameInput=function(t,e){if(e!=t){if(!this.inputs[t])return!1;if(this.inputs[e])return console.error("there is already one input with that name"),!1;this.inputs[e]=this.inputs[t],delete this.inputs[t],this._version++,this.onInputRenamed&&this.onInputRenamed(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()}},i.prototype.changeInputType=function(t,e){if(!this.inputs[t])return!1;this.inputs[t].type&&String(this.inputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.inputs[t].type=e,this._version++,this.onInputTypeChanged&&this.onInputTypeChanged(t,e))},i.prototype.removeInput=function(t){return!!this.inputs[t]&&(delete this.inputs[t],this._version++,this.onInputRemoved&&this.onInputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},i.prototype.addOutput=function(t,e,n){this.outputs[t]={name:t,type:e,value:n},this._version++,this.onOutputAdded&&this.onOutputAdded(t,e),this.onInputsOutputsChange&&this.onInputsOutputsChange()},i.prototype.setOutputData=function(t,e){var n=this.outputs[t];n&&(n.value=e)},i.prototype.getOutputData=function(t){var e=this.outputs[t];return e?e.value:null},i.prototype.renameOutput=function(t,e){return!!this.outputs[t]&&(this.outputs[e]?(console.error("there is already one output with that name"),!1):(this.outputs[e]=this.outputs[t],delete this.outputs[t],this._version++,this.onOutputRenamed&&this.onOutputRenamed(t,e),void(this.onInputsOutputsChange&&this.onInputsOutputsChange())))},i.prototype.changeOutputType=function(t,e){if(!this.outputs[t])return!1;this.outputs[t].type&&String(this.outputs[t].type).toLowerCase()==String(e).toLowerCase()||(this.outputs[t].type=e,this._version++,this.onOutputTypeChanged&&this.onOutputTypeChanged(t,e))},i.prototype.removeOutput=function(t){return!!this.outputs[t]&&(delete this.outputs[t],this._version++,this.onOutputRemoved&&this.onOutputRemoved(t),this.onInputsOutputsChange&&this.onInputsOutputsChange(),!0)},i.prototype.triggerInput=function(t,e){for(var n=this.findNodesByTitle(t),i=0;i<n.length;++i)n[i].onTrigger(e)},i.prototype.setCallback=function(t,e){for(var n=this.findNodesByTitle(t),i=0;i<n.length;++i)n[i].setTrigger(e)},i.prototype.connectionChange=function(t,e){this.updateExecutionOrder(),this.onConnectionChange&&this.onConnectionChange(t),this._version++,this.sendActionToCanvas("onConnectionChange")},i.prototype.isLive=function(){if(!this.list_of_graphcanvas)return!1;for(var t=0;t<this.list_of_graphcanvas.length;++t){if(this.list_of_graphcanvas[t].live_mode)return!0}return!1},i.prototype.clearTriggeredSlots=function(){for(var t in this.links){var e=this.links[t];e&&(e._last_time&&(e._last_time=0))}},i.prototype.change=function(){n.debug&&console.log("Graph changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change&&this.on_change(this)},i.prototype.setDirtyCanvas=function(t,e){this.sendActionToCanvas("setDirty",[t,e])},i.prototype.removeLink=function(t){var e=this.links[t];if(e){var n=this.getNodeById(e.target_id);n&&n.disconnectInput(e.target_slot)}},i.prototype.serialize=function(){for(var t=[],e=0,i=this._nodes.length;e<i;++e)t.push(this._nodes[e].serialize());var o=[];for(var e in this.links){var r=this.links[e];if(!r.serialize){console.warn("weird LLink bug, link info is not a LLink but a regular object");var a=new s;for(var e in r)a[e]=r[e];this.links[e]=a,r=a}o.push(r.serialize())}var l=[];for(e=0;e<this._groups.length;++e)l.push(this._groups[e].serialize());return{last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:t,links:o,groups:l,config:this.config,version:n.VERSION}},i.prototype.configure=function(t,e){if(t){e||this.clear();var i=t.nodes;if(t.links&&t.links.constructor===Array){for(var r=[],a=0;a<t.links.length;++a){var l=t.links[a];if(l){var u=new s;u.configure(l),r[u.id]=u}else console.warn("serialized graph link data contains errors, skipping.")}t.links=r}for(var a in t)"nodes"!=a&&"groups"!=a&&(this[a]=t[a]);var h=!1;if(this._nodes=[],i){a=0;for(var c=i.length;a<c;++a){var p=i[a];(d=n.createNode(p.type,p.title))||(n.debug&&console.log("Node not found or has errors: "+p.type),(d=new o).last_serialization=p,d.has_errors=!0,h=!0),d.id=p.id,this.add(d,!0)}for(a=0,c=i.length;a<c;++a){var d;p=i[a];(d=this.getNodeById(p.id))&&d.configure(p)}}if(this._groups.length=0,t.groups)for(a=0;a<t.groups.length;++a){var g=new n.LGraphGroup;g.configure(t.groups[a]),this.add(g)}return this.updateExecutionOrder(),this._version++,this.setDirtyCanvas(!0,!0),h}},i.prototype.load=function(t){var e=this,n=new XMLHttpRequest;n.open("GET",t,!0),n.send(null),n.onload=function(t){if(200===n.status){var i=JSON.parse(n.response);e.configure(i)}else console.error("Error loading graph:",n.status,n.response)},n.onerror=function(t){console.error("Error loading graph:",t)}},i.prototype.onNodeTrace=function(t,e,n){},s.prototype.configure=function(t){t.constructor===Array?(this.id=t[0],this.origin_id=t[1],this.origin_slot=t[2],this.target_id=t[3],this.target_slot=t[4],this.type=t[5]):(this.id=t.id,this.type=t.type,this.origin_id=t.origin_id,this.origin_slot=t.origin_slot,this.target_id=t.target_id,this.target_slot=t.target_slot)},s.prototype.serialize=function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]},n.LLink=s,e.LGraphNode=n.LGraphNode=o,o.prototype._ctor=function(t){this.title=t||"Unnamed",this.size=[n.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}},o.prototype.configure=function(t){for(var e in this.graph&&this.graph._version++,t)if("properties"!=e)null!=t[e]&&("object"==typeof t[e]?this[e]&&this[e].configure?this[e].configure(t[e]):this[e]=n.cloneObject(t[e],this[e]):this[e]=t[e]);else for(var i in t.properties)this.properties[i]=t.properties[i],this.onPropertyChanged&&this.onPropertyChanged(i,t.properties[i]);if(t.title||(this.title=this.constructor.title),this.onConnectionsChange){if(this.inputs)for(var s=0;s<this.inputs.length;++s){var o=this.inputs[s],r=this.graph?this.graph.links[o.link]:null;this.onConnectionsChange(n.INPUT,s,!0,r,o)}if(this.outputs)for(s=0;s<this.outputs.length;++s){var a=this.outputs[s];if(a.links)for(e=0;e<a.links.length;++e){r=this.graph?this.graph.links[a.links[e]]:null;this.onConnectionsChange(n.OUTPUT,s,!0,r,a)}}}if(this.widgets){for(s=0;s<this.widgets.length;++s){var l=this.widgets[s];l.options&&l.options.property&&this.properties[l.options.property]&&(l.value=JSON.parse(JSON.stringify(this.properties[l.options.property])))}if(t.widgets_values)for(s=0;s<t.widgets_values.length;++s)this.widgets[s]&&(this.widgets[s].value=t.widgets_values[s])}this.onConfigure&&this.onConfigure(t)},o.prototype.serialize=function(){var t={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:n.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===o&&this.last_serialization)return this.last_serialization;if(this.inputs&&(t.inputs=this.inputs),this.outputs){for(var e=0;e<this.outputs.length;e++)delete this.outputs[e]._data;t.outputs=this.outputs}if(this.title&&this.title!=this.constructor.title&&(t.title=this.title),this.properties&&(t.properties=n.cloneObject(this.properties)),this.widgets&&this.serialize_widgets){t.widgets_values=[];for(e=0;e<this.widgets.length;++e)t.widgets_values[e]=this.widgets[e].value}return t.type||(t.type=this.constructor.type),this.color&&(t.color=this.color),this.bgcolor&&(t.bgcolor=this.bgcolor),this.boxcolor&&(t.boxcolor=this.boxcolor),this.shape&&(t.shape=this.shape),this.onSerialize&&this.onSerialize(t)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),t},o.prototype.clone=function(){var t=n.createNode(this.type);if(!t)return null;var e=n.cloneObject(this.serialize());if(e.inputs)for(var i=0;i<e.inputs.length;++i)e.inputs[i].link=null;if(e.outputs)for(i=0;i<e.outputs.length;++i)e.outputs[i].links&&(e.outputs[i].links.length=0);return delete e.id,t.configure(e),t},o.prototype.toString=function(){return JSON.stringify(this.serialize())},o.prototype.getTitle=function(){return this.title||this.constructor.title},o.prototype.setProperty=function(t,e){if(this.properties||(this.properties={}),e!==this.properties[t]){var n=this.properties[t];this.properties[t]=e,this.onPropertyChanged&&!1===this.onPropertyChanged(t,e,n)&&(this.properties[t]=n)}},o.prototype.setOutputData=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var n=this.outputs[t];if(n&&(n._data=e,this.outputs[t].links))for(var i=0;i<this.outputs[t].links.length;i++){var s=this.outputs[t].links[i],o=this.graph.links[s];o&&(o.data=e)}}},o.prototype.setOutputDataType=function(t,e){if(this.outputs&&!(-1==t||t>=this.outputs.length)){var n=this.outputs[t];if(n&&(n.type=e,this.outputs[t].links))for(var i=0;i<this.outputs[t].links.length;i++){var s=this.outputs[t].links[i];this.graph.links[s].type=e}}},o.prototype.getInputData=function(t,e){if(this.inputs&&!(t>=this.inputs.length||null==this.inputs[t].link)){var n=this.inputs[t].link,i=this.graph.links[n];if(!i)return null;if(!e)return i.data;var s=this.graph.getNodeById(i.origin_id);return s?(s.updateOutputData?s.updateOutputData(i.origin_slot):s.onExecute&&s.onExecute(),i.data):i.data}},o.prototype.getInputDataType=function(t){if(!this.inputs)return null;if(t>=this.inputs.length||null==this.inputs[t].link)return null;var e=this.inputs[t].link,n=this.graph.links[e];if(!n)return null;var i=this.graph.getNodeById(n.origin_id);if(!i)return n.type;var s=i.outputs[n.origin_slot];return s?s.type:null},o.prototype.getInputDataByName=function(t,e){var n=this.findInputSlot(t);return-1==n?null:this.getInputData(n,e)},o.prototype.isInputConnected=function(t){return!!this.inputs&&(t<this.inputs.length&&null!=this.inputs[t].link)},o.prototype.clearInput=function(){for(var t=this.inputs.length-1;t>=0;t--)this.removeInput(t)},o.prototype.getInputInfo=function(t){return this.inputs&&t<this.inputs.length?this.inputs[t]:null},o.prototype.getInputNode=function(t){if(!this.inputs)return null;if(t>=this.inputs.length)return null;var e=this.inputs[t];if(!e||null===e.link)return null;var n=this.graph.links[e.link];return n?this.graph.getNodeById(n.origin_id):null},o.prototype.getInputNodeByName=function(t){var e=this.findInputSlot(t);return e<0?null:this.getInputNode(e)},o.prototype.getInputLinkByName=function(t){var e=this.findInputSlot(t);if(e<0)return null;if(!this.inputs)return null;if(e>=this.inputs.length)return null;var n=this.inputs[e];if(!n||null===n.link)return null;var i=this.graph.links[n.link];return i||null},o.prototype.getInputOrProperty=function(t){if(!this.inputs||!this.inputs.length)return this.properties?this.properties[t]:null;for(var e=0,n=this.inputs.length;e<n;++e){var i=this.inputs[e];if(t==i.name&&null!=i.link){var s=this.graph.links[i.link];if(s)return s.data}}return this.properties[t]},o.prototype.getOutputData=function(t){return this.outputs?t>=this.outputs.length?null:this.outputs[t]._data:null},o.prototype.getOutputInfo=function(t){return this.outputs&&t<this.outputs.length?this.outputs[t]:null},o.prototype.isOutputConnected=function(t){return!!this.outputs&&(t<this.outputs.length&&this.outputs[t].links&&this.outputs[t].links.length)},o.prototype.isAnyOutputConnected=function(){if(!this.outputs)return!1;for(var t=0;t<this.outputs.length;++t)if(this.outputs[t].links&&this.outputs[t].links.length)return!0;return!1},o.prototype.getOutputNodes=function(t){if(!this.outputs||0==this.outputs.length)return null;if(t>=this.outputs.length)return null;var e=this.outputs[t];if(!e.links||0==e.links.length)return null;for(var n=[],i=0;i<e.links.length;i++){var s=e.links[i],o=this.graph.links[s];if(o){var r=this.graph.getNodeById(o.target_id);r&&n.push(r)}}return n},o.prototype.trigger=function(t,e){if(this.outputs&&this.outputs.length){this.graph&&(this.graph._last_trigger_time=n.getTime());for(var i=0;i<this.outputs.length;++i){var s=this.outputs[i];!s||s.type!==n.EVENT||t&&s.name!=t||this.triggerSlot(i,e)}}},o.prototype.triggerSlot=function(t,e,i){if(this.outputs){var s=this.outputs[t];if(s){var o=s.links;if(o&&o.length){this.graph&&(this.graph._last_trigger_time=n.getTime());for(var r=0;r<o.length;++r){var a=o[r];if(null==i||i==a){var l=this.graph.links[o[r]];if(l){l._last_time=n.getTime();var u=this.graph.getNodeById(l.target_id);if(u){var h=u.inputs[l.target_slot];u.onAction?u.onAction(h.name,e):u.mode===n.ON_TRIGGER&&u.onExecute&&u.onExecute(e)}}}}}}}},o.prototype.clearTriggeredSlot=function(t,e){if(this.outputs){var n=this.outputs[t];if(n){var i=n.links;if(i&&i.length)for(var s=0;s<i.length;++s){var o=i[s];if(null==e||e==o){var r=this.graph.links[i[s]];r&&(r._last_time=0)}}}}},o.prototype.addProperty=function(t,e,n,i){var s={name:t,type:n,default_value:e};if(i)for(var o in i)s[o]=i[o];return this.properties_info||(this.properties_info=[]),this.properties_info.push(s),this.properties||(this.properties={}),this.properties[t]=e,s},o.prototype.addOutput=function(t,e,n){var i={name:t,type:e,links:null};if(n)for(var s in n)i[s]=n[s];return this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i),this.size=this.computeSize(),this.setDirtyCanvas(!0,!0),i},o.prototype.addOutputs=function(t){for(var e=0;e<t.length;++e){var n=t[e],i={name:n[0],type:n[1],link:null};if(t[2])for(var s in n[2])i[s]=n[2][s];this.outputs||(this.outputs=[]),this.outputs.push(i),this.onOutputAdded&&this.onOutputAdded(i)}this.size=this.computeSize(),this.setDirtyCanvas(!0,!0)},o.prototype.removeOutput=function(t){this.disconnectOutput(t),this.outputs.splice(t,1);for(var e=t;e<this.outputs.length;++e)if(this.outputs[e]&&this.outputs[e].links)for(var n=this.outputs[e].links,i=0;i<n.length;++i){var s=this.graph.links[n[i]];s&&(s.origin_slot-=1)}this.size=this.computeSize(),this.onOutputRemoved&&this.onOutputRemoved(t),this.setDirtyCanvas(!0,!0)},o.prototype.addInput=function(t,e,n){var i={name:t,type:e=e||0,link:null};if(n)for(var s in n)i[s]=n[s];return this.inputs||(this.inputs=[]),this.inputs.push(i),this.size=this.computeSize(),this.onInputAdded&&this.onInputAdded(i),this.setDirtyCanvas(!0,!0),i},o.prototype.addInputs=function(t){for(var e=0;e<t.length;++e){var n=t[e],i={name:n[0],type:n[1],link:null};if(t[2])for(var s in n[2])i[s]=n[2][s];this.inputs||(this.inputs=[]),this.inputs.push(i),this.onInputAdded&&this.onInputAdded(i)}this.size=this.computeSize(),this.setDirtyCanvas(!0,!0)},o.prototype.removeInput=function(t){this.disconnectInput(t),this.inputs.splice(t,1);for(var e=t;e<this.inputs.length;++e)if(this.inputs[e]){var n=this.graph.links[this.inputs[e].link];n&&(n.target_slot-=1)}this.size=this.computeSize(),this.onInputRemoved&&this.onInputRemoved(t),this.setDirtyCanvas(!0,!0)},o.prototype.removeInputByName=function(t){for(var e=-1,n=0;n<this.inputs.length;++n)this.inputs[n].name==t&&(e=n);e<0||this.removeInput(e)},o.prototype.removeOutputByName=function(t){for(var e=-1,n=0;n<this.inputs.length;++n)this.inputs[n].name==t&&(e=n);e<0||this.removeOutput(e)},o.prototype.addConnection=function(t,e,n,i){var s={name:t,type:e,pos:n,direction:i,links:null};return this.connections.push(s),s},o.prototype.computeSize=function(t,e){if(this.constructor.size)return this.constructor.size.concat();var i=Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1),s=e||new Float32Array([0,0]);i=Math.max(i,1);var o=n.NODE_TEXT_SIZE;s[1]=(this.constructor.slot_start_y||0)+i*n.NODE_SLOT_HEIGHT;var r=0;this.widgets&&this.widgets.length&&(r=this.widgets.length*(n.NODE_WIDGET_HEIGHT+4)+8),this.widgets_up?s[1]=Math.max(s[1],r):null!=this.widgets_start_y?s[1]=Math.max(s[1],r+this.widgets_start_y):s[1]+=r;o=o;var a=_(this.title),l=0,u=0;if(this.inputs)for(var h=0,c=this.inputs.length;h<c;++h){var p=this.inputs[h];l<(d=_(p.label||p.name||""))&&(l=d)}if(this.outputs)for(h=0,c=this.outputs.length;h<c;++h){var d,g=this.outputs[h];u<(d=_(g.label||g.name||""))&&(u=d)}function _(t){return t?o*t.length*.6:0}return s[0]=Math.max(l+u+10,a),s[0]=Math.max(s[0],n.NODE_WIDTH),this.widgets&&this.widgets.length&&(s[0]=Math.max(s[0],1.5*n.NODE_WIDTH)),this.onResize&&this.onResize(s),this.constructor.min_height&&s[1]<this.constructor.min_height&&(s[1]=this.constructor.min_height),s[1]+=6,s},o.prototype.addWidget=function(t,e,n,i,s){this.widgets||(this.widgets=[]),!s&&i&&i.constructor===Object&&(s=i,i=null),s&&s.constructor===String&&(s={property:s}),i&&i.constructor===String&&(s||(s={}),s.property=i,i=null),i&&i.constructor!==Function&&(console.warn("addWidget: callback must be a function"),i=null);var o={type:t.toLowerCase(),name:e,value:n,callback:i,options:s||{}};if(void 0!==o.options.y&&(o.y=o.options.y),i||o.options.callback||o.options.property||console.warn("LiteGraph addWidget(...) without a callback or property assigned"),"combo"==t&&!o.options.values)throw"LiteGraph addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }";return this.widgets.push(o),this.size=this.computeSize(),this.setDirtyCanvas(!0,!0),o},o.prototype.addCustomWidget=function(t){return this.widgets||(this.widgets=[]),this.widgets.push(t),t},o.prototype.getBounding=function(t){return(t=t||new Float32Array(4))[0]=this.pos[0]-4,t[1]=this.pos[1]-n.NODE_TITLE_HEIGHT,t[2]=this.size[0]+4,t[3]=this.size[1]+n.NODE_TITLE_HEIGHT,this.onBounding&&this.onBounding(t),t},o.prototype.isPointInside=function(t,e,i,s){i=i||0;var o=this.graph&&this.graph.isLive()?0:n.NODE_TITLE_HEIGHT;if(s&&(o=0),this.flags&&this.flags.collapsed){if(v(t,e,this.pos[0]-i,this.pos[1]-n.NODE_TITLE_HEIGHT-i,(this._collapsed_width||n.NODE_COLLAPSED_WIDTH)+2*i,n.NODE_TITLE_HEIGHT+2*i))return!0}else if(this.pos[0]-4-i<t&&this.pos[0]+this.size[0]+4+i>t&&this.pos[1]-o-i<e&&this.pos[1]+this.size[1]+i>e)return!0;return!1},o.prototype.getSlotInPosition=function(t,e){var n=new Float32Array(2);if(this.inputs)for(var i=0,s=this.inputs.length;i<s;++i){var o=this.inputs[i];if(this.getConnectionPos(!0,i,n),v(t,e,n[0]-10,n[1]-5,20,10))return{input:o,slot:i,link_pos:n}}if(this.outputs)for(i=0,s=this.outputs.length;i<s;++i){var r=this.outputs[i];if(this.getConnectionPos(!1,i,n),v(t,e,n[0]-10,n[1]-5,20,10))return{output:r,slot:i,link_pos:n}}return null},o.prototype.findInputSlot=function(t){if(!this.inputs)return-1;for(var e=0,n=this.inputs.length;e<n;++e)if(t==this.inputs[e].name)return e;return-1},o.prototype.findOutputSlot=function(t){if(!this.outputs)return-1;for(var e=0,n=this.outputs.length;e<n;++e)if(t==this.outputs[e].name)return e;return-1},o.prototype.connect=function(t,e,i){if(i=i||0,!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return n.debug&&console.log("Connect: Error, no slot of name "+t),null}else if(!this.outputs||t>=this.outputs.length)return n.debug&&console.log("Connect: Error, slot number not found"),null;if(e&&e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"target node is null";if(e==this)return null;if(i.constructor===String){if(-1==(i=e.findInputSlot(i)))return n.debug&&console.log("Connect: Error, no slot of name "+i),null}else{if(i===n.EVENT)return null;if(!e.inputs||i>=e.inputs.length)return n.debug&&console.log("Connect: Error, slot number not found"),null}null!=e.inputs[i].link&&e.disconnectInput(i);var o=this.outputs[t];if(e.onConnectInput&&!1===e.onConnectInput(i,o.type,o))return null;var r=e.inputs[i],a=null;return n.isValidConnection(o.type,r.type)&&(a=new s(++this.graph.last_link_id,r.type,this.id,t,e.id,i),this.graph.links[a.id]=a,null==o.links&&(o.links=[]),o.links.push(a.id),e.inputs[i].link=a.id,this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(n.OUTPUT,t,!0,a,o),e.onConnectionsChange&&e.onConnectionsChange(n.INPUT,i,!0,a,r),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(n.INPUT,e,i,this,t),this.graph.onNodeConnectionChange(n.OUTPUT,this,t,e,i))),this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this,a),a},o.prototype.disconnectOutput=function(t,e){if(t.constructor===String){if(-1==(t=this.findOutputSlot(t)))return n.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.outputs||t>=this.outputs.length)return n.debug&&console.log("Connect: Error, slot number not found"),!1;var i=this.outputs[t];if(!i||!i.links||0==i.links.length)return!1;if(e){if(e.constructor===Number&&(e=this.graph.getNodeById(e)),!e)throw"Target Node not found";for(var s=0,o=i.links.length;s<o;s++){var r=i.links[s];if((a=this.graph.links[r]).target_id==e.id){i.links.splice(s,1),(l=e.inputs[a.target_slot]).link=null,delete this.graph.links[r],this.graph&&this.graph._version++,e.onConnectionsChange&&e.onConnectionsChange(n.INPUT,a.target_slot,!1,a,l),this.onConnectionsChange&&this.onConnectionsChange(n.OUTPUT,t,!1,a,i),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(n.OUTPUT,this,t),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(n.OUTPUT,this,t),this.graph.onNodeConnectionChange(n.INPUT,e,a.target_slot));break}}}else{for(s=0,o=i.links.length;s<o;s++){var a;r=i.links[s];if(a=this.graph.links[r]){e=this.graph.getNodeById(a.target_id);var l=null;this.graph&&this.graph._version++,e&&((l=e.inputs[a.target_slot]).link=null,e.onConnectionsChange&&e.onConnectionsChange(n.INPUT,a.target_slot,!1,a,l),this.graph&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(n.INPUT,e,a.target_slot)),delete this.graph.links[r],this.onConnectionsChange&&this.onConnectionsChange(n.OUTPUT,t,!1,a,i),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(n.OUTPUT,this,t),this.graph.onNodeConnectionChange(n.INPUT,e,a.target_slot))}}i.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},o.prototype.disconnectInput=function(t){if(t.constructor===String){if(-1==(t=this.findInputSlot(t)))return n.debug&&console.log("Connect: Error, no slot of name "+t),!1}else if(!this.inputs||t>=this.inputs.length)return n.debug&&console.log("Connect: Error, slot number not found"),!1;var e=this.inputs[t];if(!e)return!1;var i=this.inputs[t].link;this.inputs[t].link=null;var s=this.graph.links[i];if(s){var o=this.graph.getNodeById(s.origin_id);if(!o)return!1;var r=o.outputs[s.origin_slot];if(!r||!r.links||0==r.links.length)return!1;for(var a=0,l=r.links.length;a<l;a++)if(r.links[a]==i){r.links.splice(a,1);break}delete this.graph.links[i],this.graph&&this.graph._version++,this.onConnectionsChange&&this.onConnectionsChange(n.INPUT,t,!1,s,e),o.onConnectionsChange&&o.onConnectionsChange(n.OUTPUT,a,!1,s,r),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(n.OUTPUT,o,a),this.graph.onNodeConnectionChange(n.INPUT,this,t))}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0},o.prototype.getConnectionPos=function(t,e,i){i=i||new Float32Array(2);var s=0;t&&this.inputs&&(s=this.inputs.length),!t&&this.outputs&&(s=this.outputs.length);var o=.5*n.NODE_SLOT_HEIGHT;if(this.flags.collapsed){var r=this._collapsed_width||n.NODE_COLLAPSED_WIDTH;return this.horizontal?(i[0]=this.pos[0]+.5*r,i[1]=t?this.pos[1]-n.NODE_TITLE_HEIGHT:this.pos[1]):(i[0]=t?this.pos[0]:this.pos[0]+r,i[1]=this.pos[1]-.5*n.NODE_TITLE_HEIGHT),i}return t&&-1==e?(i[0]=this.pos[0]+.5*n.NODE_TITLE_HEIGHT,i[1]=this.pos[1]+.5*n.NODE_TITLE_HEIGHT,i):t&&s>e&&this.inputs[e].pos?(i[0]=this.pos[0]+this.inputs[e].pos[0],i[1]=this.pos[1]+this.inputs[e].pos[1],i):!t&&s>e&&this.outputs[e].pos?(i[0]=this.pos[0]+this.outputs[e].pos[0],i[1]=this.pos[1]+this.outputs[e].pos[1],i):this.horizontal?(i[0]=this.pos[0]+(e+.5)*(this.size[0]/s),i[1]=t?this.pos[1]-n.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1],i):(i[0]=t?this.pos[0]+o:this.pos[0]+this.size[0]+1-o,i[1]=this.pos[1]+(e+.7)*n.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),i)},o.prototype.alignToGrid=function(){this.pos[0]=n.CANVAS_GRID_SIZE*Math.round(this.pos[0]/n.CANVAS_GRID_SIZE),this.pos[1]=n.CANVAS_GRID_SIZE*Math.round(this.pos[1]/n.CANVAS_GRID_SIZE)},o.prototype.trace=function(t){this.console||(this.console=[]),this.console.push(t),this.console.length>o.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace(this,t)},o.prototype.setDirtyCanvas=function(t,e){this.graph&&this.graph.sendActionToCanvas("setDirty",[t,e])},o.prototype.loadImage=function(t){var e=new Image;e.src=n.node_images_path+t,e.ready=!1;var i=this;return e.onload=function(){this.ready=!0,i.setDirtyCanvas(!0)},e},o.prototype.captureInput=function(t){if(this.graph&&this.graph.list_of_graphcanvas)for(var e=this.graph.list_of_graphcanvas,n=0;n<e.length;++n){var i=e[n];(t||i.node_capturing_input==this)&&(i.node_capturing_input=t?this:null)}},o.prototype.collapse=function(t){this.graph._version++,(!1!==this.constructor.collapsable||t)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))},o.prototype.pin=function(t){this.graph._version++,this.flags.pinned=void 0===t?!this.flags.pinned:t},o.prototype.localToScreen=function(t,e,n){return[(t+this.pos[0])*n.scale+n.offset[0],(e+this.pos[1])*n.scale+n.offset[1]]},e.LGraphGroup=n.LGraphGroup=r,r.prototype._ctor=function(t){this.title=t||"Group",this.font_size=24,this.color=l.node_colors.pale_blue?l.node_colors.pale_blue.groupcolor:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null,Object.defineProperty(this,"pos",{set:function(t){!t||t.length<2||(this._pos[0]=t[0],this._pos[1]=t[1])},get:function(){return this._pos},enumerable:!0}),Object.defineProperty(this,"size",{set:function(t){!t||t.length<2||(this._size[0]=Math.max(140,t[0]),this._size[1]=Math.max(80,t[1]))},get:function(){return this._size},enumerable:!0})},r.prototype.configure=function(t){this.title=t.title,this._bounding.set(t.bounding),this.color=t.color,this.font=t.font},r.prototype.serialize=function(){var t=this._bounding;return{title:this.title,bounding:[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])],color:this.color,font:this.font}},r.prototype.move=function(t,e,n){if(this._pos[0]+=t,this._pos[1]+=e,!n)for(var i=0;i<this._nodes.length;++i){var s=this._nodes[i];s.pos[0]+=t,s.pos[1]+=e}},r.prototype.recomputeInsideNodes=function(){this._nodes.length=0;for(var t=this.graph._nodes,e=new Float32Array(4),n=0;n<t.length;++n){var i=t[n];i.getBounding(e),m(this._bounding,e)&&this._nodes.push(i)}},r.prototype.isPointInside=o.prototype.isPointInside,r.prototype.setDirtyCanvas=o.prototype.setDirtyCanvas,n.DragAndScale=a,a.prototype.bindEvents=function(t){this.last_mouse=new Float32Array(2),this._binded_mouse_callback=this.onMouse.bind(this),t.addEventListener("mousedown",this._binded_mouse_callback),t.addEventListener("mousemove",this._binded_mouse_callback),t.addEventListener("mousewheel",this._binded_mouse_callback,!1),t.addEventListener("wheel",this._binded_mouse_callback,!1)},a.prototype.computeVisibleArea=function(){if(this.element){var t=this.element.width,e=this.element.height,n=-this.offset[0],i=-this.offset[1],s=n+t/this.scale,o=i+e/this.scale;this.visible_area[0]=n,this.visible_area[1]=i,this.visible_area[2]=s-n,this.visible_area[3]=o-i}else this.visible_area[0]=this.visible_area[1]=this.visible_area[2]=this.visible_area[3]=0},a.prototype.onMouse=function(t){if(this.enabled){var e=this.element,n=e.getBoundingClientRect(),i=t.clientX-n.left,s=t.clientY-n.top;t.canvasx=i,t.canvasy=s,t.dragging=this.dragging;var o=!1;if(this.onmouse&&(o=this.onmouse(t)),"mousedown"==t.type)this.dragging=!0,e.removeEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mousemove",this._binded_mouse_callback),document.body.addEventListener("mouseup",this._binded_mouse_callback);else if("mousemove"==t.type){if(!o){var r=i-this.last_mouse[0],a=s-this.last_mouse[1];this.dragging&&this.mouseDrag(r,a)}}else"mouseup"==t.type?(this.dragging=!1,document.body.removeEventListener("mousemove",this._binded_mouse_callback),document.body.removeEventListener("mouseup",this._binded_mouse_callback),e.addEventListener("mousemove",this._binded_mouse_callback)):"mousewheel"!=t.type&&"wheel"!=t.type&&"DOMMouseScroll"!=t.type||(t.eventType="mousewheel","wheel"==t.type?t.wheel=-t.deltaY:t.wheel=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail,t.delta=t.wheelDelta?t.wheelDelta/40:t.deltaY?-t.deltaY/3:0,this.changeDeltaScale(1+.05*t.delta));return this.last_mouse[0]=i,this.last_mouse[1]=s,t.preventDefault(),t.stopPropagation(),!1}},a.prototype.toCanvasContext=function(t){t.scale(this.scale,this.scale),t.translate(this.offset[0],this.offset[1])},a.prototype.convertOffsetToCanvas=function(t){return[(t[0]+this.offset[0])*this.scale,(t[1]+this.offset[1])*this.scale]},a.prototype.convertCanvasToOffset=function(t,e){return(e=e||[0,0])[0]=t[0]/this.scale-this.offset[0],e[1]=t[1]/this.scale-this.offset[1],e},a.prototype.mouseDrag=function(t,e){this.offset[0]+=t/this.scale,this.offset[1]+=e/this.scale,this.onredraw&&this.onredraw(this)},a.prototype.changeScale=function(t,e){if(t<this.min_scale?t=this.min_scale:t>this.max_scale&&(t=this.max_scale),t!=this.scale&&this.element){var n=this.element.getBoundingClientRect();if(n){e=e||[.5*n.width,.5*n.height];var i=this.convertCanvasToOffset(e);this.scale=t,Math.abs(this.scale-1)<.01&&(this.scale=1);var s=this.convertCanvasToOffset(e),o=[s[0]-i[0],s[1]-i[1]];this.offset[0]+=o[0],this.offset[1]+=o[1],this.onredraw&&this.onredraw(this)}}},a.prototype.changeDeltaScale=function(t,e){this.changeScale(this.scale*t,e)},a.prototype.reset=function(){this.scale=1,this.offset[0]=0,this.offset[1]=0},e.LGraphCanvas=n.LGraphCanvas=l,l.link_type_colors={"-1":n.EVENT_LINK_COLOR,number:"#AAA",node:"#DCA"},l.gradients={},l.prototype.clear=function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.visible_area.set([0,0,0,0]),this.onClear&&this.onClear()},l.prototype.setGraph=function(t,e){this.graph!=t&&(e||this.clear(),t||!this.graph?(t.attachCanvas(this),this.setDirty(!0,!0)):this.graph.detachCanvas(this))},l.prototype.openSubgraph=function(t){if(!t)throw"graph cannot be null";if(this.graph==t)throw"graph cannot be the same";this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph)),t.attachCanvas(this),this.setDirty(!0,!0)},l.prototype.closeSubgraph=function(){if(this._graph_stack&&0!=this._graph_stack.length){var t=this.graph._subgraph_node,e=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},e.attachCanvas(this),this.setDirty(!0,!0),t&&(this.centerOnNode(t),this.selectNodes([t]))}},l.prototype.getCurrentGraph=function(){return this.graph},l.prototype.setCanvas=function(t,e){if(t&&t.constructor===String&&!(t=document.getElementById(t)))throw"Error creating LiteGraph canvas: Canvas not found";if(t!==this.canvas&&(!t&&this.canvas&&(e||this.unbindEvents()),this.canvas=t,this.ds.element=t,t)){if(t.className+=" lgraphcanvas",t.data=this,t.tabindex="1",this.bgcanvas=null,this.bgcanvas||(this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height),null==t.getContext){if("canvas"!=t.localName)throw"Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+t.localName;throw"This browser doesn't support Canvas"}null==(this.ctx=t.getContext("2d"))&&(t.webgl_enabled||console.warn("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),e||this.bindEvents()}},l.prototype._doNothing=function(t){return t.preventDefault(),!1},l.prototype._doReturnTrue=function(t){return t.preventDefault(),!0},l.prototype.bindEvents=function(){if(this._events_binded)console.warn("LGraphCanvas: events already binded");else{var t=this.canvas,e=this.getCanvasWindow().document;this._mousedown_callback=this.processMouseDown.bind(this),this._mousewheel_callback=this.processMouseWheel.bind(this),t.addEventListener("mousedown",this._mousedown_callback,!0),t.addEventListener("mousemove",this._mousemove_callback),t.addEventListener("mousewheel",this._mousewheel_callback,!1),t.addEventListener("contextmenu",this._doNothing),t.addEventListener("DOMMouseScroll",this._mousewheel_callback,!1),this.touchHandler=this.touchHandler.bind(this),t.addEventListener("touchstart",this.touchHandler,!0),t.addEventListener("touchmove",this.touchHandler,!0),t.addEventListener("touchend",this.touchHandler,!0),t.addEventListener("touchcancel",this.touchHandler,!0),this._key_callback=this.processKey.bind(this),t.addEventListener("keydown",this._key_callback,!0),e.addEventListener("keyup",this._key_callback,!0),this._ondrop_callback=this.processDrop.bind(this),t.addEventListener("dragover",this._doNothing,!1),t.addEventListener("dragend",this._doNothing,!1),t.addEventListener("drop",this._ondrop_callback,!1),t.addEventListener("dragenter",this._doReturnTrue,!1),this._events_binded=!0}},l.prototype.unbindEvents=function(){if(this._events_binded){var t=this.getCanvasWindow().document;this.canvas.removeEventListener("mousedown",this._mousedown_callback),this.canvas.removeEventListener("mousewheel",this._mousewheel_callback),this.canvas.removeEventListener("DOMMouseScroll",this._mousewheel_callback),this.canvas.removeEventListener("keydown",this._key_callback),t.removeEventListener("keyup",this._key_callback),this.canvas.removeEventListener("contextmenu",this._doNothing),this.canvas.removeEventListener("drop",this._ondrop_callback),this.canvas.removeEventListener("dragenter",this._doReturnTrue),this.canvas.removeEventListener("touchstart",this.touchHandler),this.canvas.removeEventListener("touchmove",this.touchHandler),this.canvas.removeEventListener("touchend",this.touchHandler),this.canvas.removeEventListener("touchcancel",this.touchHandler),this._mousedown_callback=null,this._mousewheel_callback=null,this._key_callback=null,this._ondrop_callback=null,this._events_binded=!1}else console.warn("LGraphCanvas: no events binded")},l.getFileExtension=function(t){var e=t.indexOf("?");-1!=e&&(t=t.substr(0,e));var n=t.lastIndexOf(".");return-1==n?"":t.substr(n+1).toLowerCase()},l.prototype.enableWebGL=function(){if(void 0===typeof GL)throw"litegl.js must be included to use a WebGL canvas";if(void 0===typeof enableWebGLCanvas)throw"webglCanvas.js must be included to use this feature";this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0},l.prototype.setDirty=function(t,e){t&&(this.dirty_canvas=!0),e&&(this.dirty_bgcanvas=!0)},l.prototype.getCanvasWindow=function(){if(!this.canvas)return window;var t=this.canvas.ownerDocument;return t.defaultView||t.parentWindow},l.prototype.startRendering=function(){this.is_rendering||(this.is_rendering=!0,function t(){this.pause_rendering||this.draw();var e=this.getCanvasWindow();this.is_rendering&&e.requestAnimationFrame(t.bind(this))}.call(this))},l.prototype.stopRendering=function(){this.is_rendering=!1},l.prototype.processMouseDown=function(t){if(this.graph){this.adjustMouseEvent(t);var e=this.getCanvasWindow();e.document;l.active_canvas=this;this.canvas.removeEventListener("mousemove",this._mousemove_callback),e.document.addEventListener("mousemove",this._mousemove_callback,!0),e.document.addEventListener("mouseup",this._mouseup_callback,!0);var i=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes,5),s=!1,o=n.getTime()-this.last_mouseclick<300;if(this.canvas_mouse[0]=t.canvasX,this.canvas_mouse[1]=t.canvasY,this.canvas.focus(),n.closeAllContextMenus(e),!this.onMouse||1!=this.onMouse(t)){if(1==t.which){t.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=t.canvasX,this.dragging_rectangle[1]=t.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,s=!0);var r=!1;if(i&&this.allow_interaction&&!s&&!this.read_only){if(this.live_mode||i.flags.pinned||this.bringToFront(i),!this.connecting_node&&!i.flags.collapsed&&!this.live_mode)if(!s&&!1!==i.resizable&&v(t.canvasX,t.canvasY,i.pos[0]+i.size[0]-5,i.pos[1]+i.size[1]-5,10,10))this.resizing_node=i,this.canvas.style.cursor="se-resize",s=!0;else{if(i.outputs)for(var a=0,u=i.outputs.length;a<u;++a){var h=i.outputs[a],c=i.getConnectionPos(!1,a);if(v(t.canvasX,t.canvasY,c[0]-15,c[1]-10,30,20)){this.connecting_node=i,this.connecting_output=h,this.connecting_pos=i.getConnectionPos(!1,a),this.connecting_slot=a,t.shiftKey&&i.disconnectOutput(a),o?i.onOutputDblClick&&i.onOutputDblClick(a,t):i.onOutputClick&&i.onOutputClick(a,t),s=!0;break}}if(i.inputs)for(a=0,u=i.inputs.length;a<u;++a){var p=i.inputs[a];c=i.getConnectionPos(!0,a);if(v(t.canvasX,t.canvasY,c[0]-15,c[1]-10,30,20)&&(o?i.onInputDblClick&&i.onInputDblClick(a,t):i.onInputClick&&i.onInputClick(a,t),null!==p.link)){var d=this.graph.links[p.link];i.disconnectInput(a),(this.allow_reconnect_links||t.shiftKey)&&(this.connecting_node=this.graph._nodes_by_id[d.origin_id],this.connecting_slot=d.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot)),this.dirty_bgcanvas=!0,s=!0}}}if(!s){var g=!1,_=this.processNodeWidgets(i,this.canvas_mouse,t);_&&(g=!0,this.node_widget=[i,_]),o&&this.selected_nodes[i.id]&&(i.onDblClick&&i.onDblClick(t,[t.canvasX-i.pos[0],t.canvasY-i.pos[1]],this),this.processNodeDblClicked(i),g=!0),i.onMouseDown&&i.onMouseDown(t,[t.canvasX-i.pos[0],t.canvasY-i.pos[1]],this)?g=!0:this.live_mode&&(r=!0,g=!0),g||(this.allow_dragnodes&&(this.node_dragged=i),this.selected_nodes[i.id]||this.processNodeSelected(i,t)),this.dirty_canvas=!0}}else{if(!this.read_only)for(a=0;a<this.visible_links.length;++a){var m=this.visible_links[a],y=m._pos;if(!(!y||t.canvasX<y[0]-4||t.canvasX>y[0]+4||t.canvasY<y[1]-4||t.canvasY>y[1]+4)){this.showLinkMenu(m,t),this.over_link_center=null;break}}if(this.selected_group=this.graph.getGroupOnPos(t.canvasX,t.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only)t.ctrlKey&&(this.dragging_rectangle=null),f([t.canvasX,t.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes();o&&!this.read_only&&this.allow_searchbox&&this.showSearchBox(t),r=!0}!s&&r&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}else 2==t.which||3==t.which&&(this.read_only||this.processContextMenu(i,t));return this.last_mouse[0]=t.localX,this.last_mouse[1]=t.localY,this.last_mouseclick=n.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!e.document.activeElement||"input"!=e.document.activeElement.nodeName.toLowerCase()&&"textarea"!=e.document.activeElement.nodeName.toLowerCase())&&t.preventDefault(),t.stopPropagation(),this.onMouseDown&&this.onMouseDown(t),!1}}},l.prototype.processMouseMove=function(t){if(this.autoresize&&this.resize(),this.graph){l.active_canvas=this,this.adjustMouseEvent(t);var e=[t.localX,t.localY],i=[e[0]-this.last_mouse[0],e[1]-this.last_mouse[1]];if(this.last_mouse=e,this.canvas_mouse[0]=t.canvasX,this.canvas_mouse[1]=t.canvasY,t.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.canvas_mouse,t,this.node_widget[1]),this.dirty_canvas=!0),this.dragging_rectangle)this.dragging_rectangle[2]=t.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=t.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)this.selected_group.size=[t.canvasX-this.selected_group.pos[0],t.canvasY-this.selected_group.pos[1]];else{var s=i[0]/this.ds.scale,o=i[1]/this.ds.scale;this.selected_group.move(s,o,t.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)this.ds.offset[0]+=i[0]/this.ds.scale,this.ds.offset[1]+=i[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if(this.allow_interaction&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var r=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes),a=0,u=this.graph._nodes.length;a<u;++a)this.graph._nodes[a].mouseOver&&r!=this.graph._nodes[a]&&(this.graph._nodes[a].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(t),this.node_over=null,this.dirty_canvas=!0);if(r){if(r.mouseOver||(r.mouseOver=!0,this.node_over=r,this.dirty_canvas=!0,r.onMouseEnter&&r.onMouseEnter(t)),r.onMouseMove&&r.onMouseMove(t,[t.canvasX-r.pos[0],t.canvasY-r.pos[1]],this),this.connecting_node){var h=this._highlight_input||[0,0];if(this.isOverNodeBox(r,t.canvasX,t.canvasY));else{var c=this.isOverNodeInput(r,t.canvasX,t.canvasY,h);if(-1!=c&&r.inputs[c]){var p=r.inputs[c].type;n.isValidConnection(this.connecting_output.type,p)&&(this._highlight_input=h)}else this._highlight_input=null}}this.canvas&&(v(t.canvasX,t.canvasY,r.pos[0]+r.size[0]-5,r.pos[1]+r.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{var d=null;for(a=0;a<this.visible_links.length;++a){var g=this.visible_links[a],_=g._pos;if(!(!_||t.canvasX<_[0]-4||t.canvasX>_[0]+4||t.canvasY<_[1]-4||t.canvasY>_[1]+4)){d=g;break}}d!=this.over_link_center&&(this.over_link_center=d,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=r&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var a in this.selected_nodes){var f=this.selected_nodes[a];f.pos[0]+=i[0]/this.ds.scale,f.pos[1]+=i[1]/this.ds.scale}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){this.resizing_node.size[0]=t.canvasX-this.resizing_node.pos[0],this.resizing_node.size[1]=t.canvasY-this.resizing_node.pos[1];var m=Math.max(this.resizing_node.inputs?this.resizing_node.inputs.length:0,this.resizing_node.outputs?this.resizing_node.outputs.length:0)*n.NODE_SLOT_HEIGHT+(this.resizing_node.widgets?this.resizing_node.widgets.length:0)*(n.NODE_WIDGET_HEIGHT+4)+4;this.resizing_node.size[1]<m&&(this.resizing_node.size[1]=m),this.resizing_node.size[0]<n.NODE_MIN_WIDTH&&(this.resizing_node.size[0]=n.NODE_MIN_WIDTH),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}return t.preventDefault(),!1}},l.prototype.processMouseUp=function(t){if(this.graph){var e=this.getCanvasWindow().document;l.active_canvas=this,e.removeEventListener("mousemove",this._mousemove_callback,!0),this.canvas.addEventListener("mousemove",this._mousemove_callback,!0),e.removeEventListener("mouseup",this._mouseup_callback,!0),this.adjustMouseEvent(t);var i=n.getTime();if(t.click_time=i-this.last_mouseclick,this.last_mouse_dragging=!1,1==t.which){if(this.node_widget=null,this.selected_group){var s=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),o=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(s,o,t.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null}if(this.selected_group_resizing=!1,this.dragging_rectangle){if(this.graph){var r=this.graph._nodes,a=new Float32Array(4);this.deselectAllNodes();var u=Math.abs(this.dragging_rectangle[2]),h=Math.abs(this.dragging_rectangle[3]),c=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-u:this.dragging_rectangle[0],p=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-h:this.dragging_rectangle[1];this.dragging_rectangle[0]=c,this.dragging_rectangle[1]=p,this.dragging_rectangle[2]=u,this.dragging_rectangle[3]=h;for(var d=[],g=0;g<r.length;++g){(y=r[g]).getBounding(a),m(this.dragging_rectangle,a)&&d.push(y)}d.length&&this.selectNodes(d)}this.dragging_rectangle=null}else if(this.connecting_node){if(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,y=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes))if(this.connecting_output.type==n.EVENT&&this.isOverNodeBox(y,t.canvasX,t.canvasY))this.connecting_node.connect(this.connecting_slot,y,n.EVENT);else{var _=this.isOverNodeInput(y,t.canvasX,t.canvasY);if(-1!=_)this.connecting_node.connect(this.connecting_slot,y,_);else{var f=y.getInputInfo(0);this.connecting_output.type==n.EVENT?this.connecting_node.connect(this.connecting_slot,y,n.EVENT):f&&!f.link&&n.isValidConnection(f.type&&this.connecting_output.type)&&this.connecting_node.connect(this.connecting_slot,y,0)}}this.connecting_output=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.resizing_node=null;else if(this.node_dragged){(y=this.node_dragged)&&t.click_time<300&&v(t.canvasX,t.canvasY,y.pos[0],y.pos[1]-n.NODE_TITLE_HEIGHT,n.NODE_TITLE_HEIGHT,n.NODE_TITLE_HEIGHT)&&y.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),this.graph.config.align_to_grid&&this.node_dragged.alignToGrid(),this.onNodeMoved&&this.onNodeMoved(this.node_dragged),this.node_dragged=null}else{var y;!(y=this.graph.getNodeOnPos(t.canvasX,t.canvasY,this.visible_nodes))&&t.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(t,[t.canvasX-this.node_over.pos[0],t.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(t,[t.canvasX-this.node_capturing_input.pos[0],t.canvasY-this.node_capturing_input.pos[1]])}}else 2==t.which?(this.dirty_canvas=!0,this.dragging_canvas=!1):3==t.which&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return this.graph.change(),t.stopPropagation(),t.preventDefault(),!1}},l.prototype.processMouseWheel=function(t){if(this.graph&&this.allow_dragcanvas){var e=null!=t.wheelDeltaY?t.wheelDeltaY:-60*t.detail;this.adjustMouseEvent(t);var n=this.ds.scale;return e>0?n*=1.1:e<0&&(n*=1/1.1),this.ds.changeScale(n,[t.localX,t.localY]),this.graph.change(),t.preventDefault(),!1}},l.prototype.isOverNodeBox=function(t,e,i){var s=n.NODE_TITLE_HEIGHT;return!!v(e,i,t.pos[0]+2,t.pos[1]+2-s,s-4,s-4)},l.prototype.isOverNodeInput=function(t,e,n,i){if(t.inputs)for(var s=0,o=t.inputs.length;s<o;++s){t.inputs[s];var r=t.getConnectionPos(!0,s);if(t.horizontal?v(e,n,r[0]-5,r[1]-10,10,20):v(e,n,r[0]-10,r[1]-5,40,10))return i&&(i[0]=r[0],i[1]=r[1]),s}return-1},l.prototype.processKey=function(t){if(this.graph){var e=!1;if("input"!=t.target.localName){if("keydown"==t.type){if(32==t.keyCode&&(this.dragging_canvas=!0,e=!0),65==t.keyCode&&t.ctrlKey&&(this.selectNodes(),e=!0),"KeyC"!=t.code||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.selected_nodes&&(this.copyToClipboard(),e=!0),"KeyV"!=t.code||!t.metaKey&&!t.ctrlKey||t.shiftKey||this.pasteFromClipboard(),46!=t.keyCode&&8!=t.keyCode||"input"!=t.target.localName&&"textarea"!=t.target.localName&&(this.deleteSelectedNodes(),e=!0),this.selected_nodes)for(var n in this.selected_nodes)this.selected_nodes[n].onKeyDown&&this.selected_nodes[n].onKeyDown(t)}else if("keyup"==t.type&&(32==t.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(var n in this.selected_nodes)this.selected_nodes[n].onKeyUp&&this.selected_nodes[n].onKeyUp(t);return this.graph.change(),e?(t.preventDefault(),t.stopImmediatePropagation(),!1):void 0}}},l.prototype.copyToClipboard=function(){var t={nodes:[],links:[]},e=0,n=[];for(var i in this.selected_nodes){(s=this.selected_nodes[i])._relative_id=e,n.push(s),e+=1}for(i=0;i<n.length;++i){var s,o=(s=n[i]).clone();if(o){if(t.nodes.push(o.serialize()),s.inputs&&s.inputs.length)for(var r=0;r<s.inputs.length;++r){var a=s.inputs[r];if(a&&null!=a.link){var l=this.graph.links[a.link];if(l){var u=this.graph.getNodeById(l.origin_id);u&&this.selected_nodes[u.id]&&t.links.push([u._relative_id,l.origin_slot,s._relative_id,l.target_slot])}}}}else console.warn("node type not found: "+s.type)}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(t))},l.prototype.pasteFromClipboard=function(){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){for(var e=JSON.parse(t),i=[],s=0;s<e.nodes.length;++s){var o=e.nodes[s],r=n.createNode(o.type);r&&(r.configure(o),r.pos[0]+=5,r.pos[1]+=5,this.graph.add(r),i.push(r))}for(s=0;s<e.links.length;++s){var a=e.links[s],l=i[a[0]],u=i[a[2]];l&&u?l.connect(a[1],u,a[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(i)}},l.prototype.processDrop=function(t){t.preventDefault(),this.adjustMouseEvent(t);var e=[t.canvasX,t.canvasY],n=this.graph.getNodeOnPos(e[0],e[1]);if(!n){var i=null;return this.onDropItem&&(i=this.onDropItem(event)),void(i||this.checkDropItem(t))}if(n.onDropFile||n.onDropData){var s=t.dataTransfer.files;if(s&&s.length)for(var o=0;o<s.length;o++){var r=t.dataTransfer.files[0],a=r.name;l.getFileExtension(a);if(n.onDropFile&&n.onDropFile(r),n.onDropData){var u=new FileReader;u.onload=function(t){var e=t.target.result;n.onDropData(e,a,r)};var h=r.type.split("/")[0];"text"==h||""==h?u.readAsText(r):"image"==h?u.readAsDataURL(r):u.readAsArrayBuffer(r)}}}return!(!n.onDropItem||!n.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)},l.prototype.checkDropItem=function(t){if(t.dataTransfer.files.length){var e=t.dataTransfer.files[0],i=l.getFileExtension(e.name).toLowerCase(),s=n.node_types_by_file_extension[i];if(s){var o=n.createNode(s.type);o.pos=[t.canvasX,t.canvasY],this.graph.add(o),o.onDropFile&&o.onDropFile(e)}}},l.prototype.processNodeDblClicked=function(t){this.onShowNodePanel&&this.onShowNodePanel(t),this.onNodeDblClicked&&this.onNodeDblClicked(t),this.setDirty(!0)},l.prototype.processNodeSelected=function(t,e){this.selectNode(t,e&&e.shiftKey),this.onNodeSelected&&this.onNodeSelected(t)},l.prototype.selectNode=function(t,e){null==t?this.deselectAllNodes():this.selectNodes([t],e)},l.prototype.selectNodes=function(t,e){e||this.deselectAllNodes(),t=t||this.graph._nodes;for(var n=0;n<t.length;++n){var i=t[n];if(!i.is_selected){if(!i.is_selected&&i.onSelected&&i.onSelected(),i.is_selected=!0,this.selected_nodes[i.id]=i,i.inputs)for(var s=0;s<i.inputs.length;++s)this.highlighted_links[i.inputs[s].link]=!0;if(i.outputs)for(s=0;s<i.outputs.length;++s){var o=i.outputs[s];if(o.links)for(var r=0;r<o.links.length;++r)this.highlighted_links[o.links[r]]=!0}}}this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)},l.prototype.deselectNode=function(t){if(t.is_selected){if(t.onDeselected&&t.onDeselected(),t.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(t),t.inputs)for(var e=0;e<t.inputs.length;++e)delete this.highlighted_links[t.inputs[e].link];if(t.outputs)for(e=0;e<t.outputs.length;++e){var n=t.outputs[e];if(n.links)for(var i=0;i<n.links.length;++i)delete this.highlighted_links[n.links[i]]}}},l.prototype.deselectAllNodes=function(){if(this.graph){for(var t=this.graph._nodes,e=0,n=t.length;e<n;++e){var i=t[e];i.is_selected&&(i.onDeselected&&i.onDeselected(),i.is_selected=!1,this.onNodeDeselected&&this.onNodeDeselected(i))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange&&this.onSelectionChange(this.selected_nodes),this.setDirty(!0)}},l.prototype.deleteSelectedNodes=function(){for(var t in this.selected_nodes){var e=this.selected_nodes[t];if(e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&n.isValidConnection(e.inputs[0].type,e.outputs[0].type)&&e.inputs[0].link&&e.outputs[0].links&&e.outputs[0].links.length){var i=e.graph.links[e.inputs[0].link],s=e.graph.links[e.outputs[0].links[0]],o=e.getInputNode(0),r=e.getOutputNodes(0)[0];o&&r&&o.connect(i.origin_slot,r,s.target_slot)}this.graph.remove(e),this.onNodeDeselected&&this.onNodeDeselected(e)}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0)},l.prototype.centerOnNode=function(t){this.ds.offset[0]=-t.pos[0]-.5*t.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-t.pos[1]-.5*t.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)},l.prototype.adjustMouseEvent=function(t){if(this.canvas){var e=this.canvas.getBoundingClientRect();t.localX=t.clientX-e.left,t.localY=t.clientY-e.top}else t.localX=t.clientX,t.localY=t.clientY;t.deltaX=t.localX-this.last_mouse_position[0],t.deltaY=t.localY-this.last_mouse_position[1],this.last_mouse_position[0]=t.localX,this.last_mouse_position[1]=t.localY,t.canvasX=t.localX/this.ds.scale-this.ds.offset[0],t.canvasY=t.localY/this.ds.scale-this.ds.offset[1]},l.prototype.setZoom=function(t,e){this.ds.changeScale(t,e),this.dirty_canvas=!0,this.dirty_bgcanvas=!0},l.prototype.convertOffsetToCanvas=function(t,e){return this.ds.convertOffsetToCanvas(t,e)},l.prototype.convertCanvasToOffset=function(t,e){return this.ds.convertCanvasToOffset(t,e)},l.prototype.convertEventToCanvasOffset=function(t){var e=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([t.clientX-e.left,t.clientY-e.top])},l.prototype.bringToFront=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.push(t))},l.prototype.sendToBack=function(t){var e=this.graph._nodes.indexOf(t);-1!=e&&(this.graph._nodes.splice(e,1),this.graph._nodes.unshift(t))};var u=new Float32Array(4);l.prototype.computeVisibleNodes=function(t,e){var n=e||[];n.length=0;for(var i=0,s=(t=t||this.graph._nodes).length;i<s;++i){var o=t[i];(!this.live_mode||o.onDrawBackground||o.onDrawForeground)&&(m(this.visible_area,o.getBounding(u))&&n.push(o))}return n},l.prototype.draw=function(t,e){if(this.canvas){var i=n.getTime();this.render_time=.001*(i-this.last_draw_time),this.last_draw_time=i,this.graph&&this.ds.computeVisibleArea(),(this.dirty_bgcanvas||e||this.always_render_background||this.graph&&this.graph._last_trigger_time&&i-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(this.dirty_canvas||t)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1}},l.prototype.drawFrontCanvas=function(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var t=this.ctx;if(t){t.start2D&&t.start2D();var e=this.canvas;if(t.restore(),t.setTransform(1,0,0,1,0,0),this.dirty_area&&(t.save(),t.beginPath(),t.rect(this.dirty_area[0],this.dirty_area[1],this.dirty_area[2],this.dirty_area[3]),t.clip()),this.clear_background&&t.clearRect(0,0,e.width,e.height),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.onRender&&this.onRender(e,t),this.show_info&&this.renderInfo(t),this.graph){t.save(),this.ds.toCanvasContext(t);for(var i=this.computeVisibleNodes(null,this.visible_nodes),s=0;s<i.length;++s){var o=i[s];t.save(),t.translate(o.pos[0],o.pos[1]),this.drawNode(o,t),1,t.restore()}if(this.render_execution_order&&this.drawExecutionOrder(t),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(t)),null!=this.connecting_pos){t.lineWidth=this.connections_width;var r=null;switch(this.connecting_output.type){case n.EVENT:r=n.EVENT_LINK_COLOR;break;default:r=n.CONNECTING_LINK_COLOR}this.renderLink(t,this.connecting_pos,[this.canvas_mouse[0],this.canvas_mouse[1]],null,!1,null,r,this.connecting_output.dir||(this.connecting_node.horizontal?n.DOWN:n.RIGHT),n.CENTER),t.beginPath(),this.connecting_output.type===n.EVENT||this.connecting_output.shape===n.BOX_SHAPE?t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10):t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),t.fill(),t.fillStyle="#ffcc00",this._highlight_input&&(t.beginPath(),t.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),t.fill())}this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.onDrawLinkTooltip&&this.onDrawLinkTooltip(t,null),this.onDrawForeground&&this.onDrawForeground(t,this.visible_rect),t.restore()}this.onDrawOverlay&&this.onDrawOverlay(t),this.dirty_area&&t.restore(),t.finish2D&&t.finish2D()}},l.prototype.renderInfo=function(t,e,n){e=e||0,n=n||0,t.save(),t.translate(e,n),t.font="10px Arial",t.fillStyle="#888",this.graph?(t.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),t.fillText("I: "+this.graph.iteration,5,26),t.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),t.fillText("V: "+this.graph._version,5,52),t.fillText("FPS:"+this.fps.toFixed(2),5,65)):t.fillText("No graph selected",5,13),t.restore()},l.prototype.drawBackCanvas=function(){var t=this.bgcanvas;t.width==this.canvas.width&&t.height==this.canvas.height||(t.width=this.canvas.width,t.height=this.canvas.height),this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var e=this.bgctx;if(e.start&&e.start(),this.clear_background&&e.clearRect(0,0,t.width,t.height),this._graph_stack&&this._graph_stack.length){e.save();this._graph_stack[this._graph_stack.length-1];var n=this.graph._subgraph_node;e.strokeStyle=n.bgcolor,e.lineWidth=10,e.strokeRect(1,1,t.width-2,t.height-2),e.lineWidth=1,e.font="40px Arial",e.textAlign="center",e.fillStyle=n.bgcolor||"#AAA";for(var i="",s=1;s<this._graph_stack.length;++s)i+=this._graph_stack[s]._subgraph_node.getTitle()+" >> ";e.fillText(i+n.getTitle(),.5*t.width,40),e.restore()}var o=!1;if(this.onRenderBackground&&(o=this.onRenderBackground(t,e)),e.restore(),e.setTransform(1,0,0,1,0,0),this.visible_links.length=0,this.graph){if(e.save(),this.ds.toCanvasContext(e),e.mozImageSmoothingEnabled=!1,e.oImageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1,e.msImageSmoothingEnabled=!1,e.imageSmoothingEnabled=!1,this.background_image&&this.ds.scale>.5&&!o){if(this.zoom_modify_alpha?e.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:e.globalAlpha=this.editor_alpha,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var r=this;this._bg_img.onload=function(){r.draw(!0,!0)}}var a=null;null==this._pattern&&this._bg_img.width>0?(a=e.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=a):a=this._pattern,a&&(e.fillStyle=a,e.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),e.fillStyle="transparent"),e.globalAlpha=1}this.graph._groups.length&&!this.live_mode&&this.drawGroups(t,e),this.onDrawBackground&&this.onDrawBackground(e,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(e.strokeStyle="#235",e.strokeRect(0,0,t.width,t.height)),this.render_connections_shadows?(e.shadowColor="#000",e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=6):e.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(e),e.shadowColor="rgba(0,0,0,0)",e.restore()}e.finish&&e.finish(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0};var h=new Float32Array(2);l.prototype.drawNode=function(t,e){this.current_node=t;var i=t.color||t.constructor.color||n.NODE_DEFAULT_COLOR,s=t.bgcolor||t.constructor.bgcolor||n.NODE_DEFAULT_BGCOLOR;t.mouseOver;var o=this.ds.scale<.6;if(this.live_mode)t.flags.collapsed||(e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas));else{var r=this.editor_alpha;if(e.globalAlpha=r,this.render_shadows&&!o?(e.shadowColor=n.DEFAULT_SHADOW_COLOR,e.shadowOffsetX=2*this.ds.scale,e.shadowOffsetY=2*this.ds.scale,e.shadowBlur=3*this.ds.scale):e.shadowColor="transparent",!t.flags.collapsed||!t.onDrawCollapsed||1!=t.onDrawCollapsed(e,this)){var a=t._shape||n.BOX_SHAPE,l=h;h.set(t.size);var u=t.horizontal;if(t.flags.collapsed){e.font=this.inner_text_font;var c=t.getTitle?t.getTitle():t.title;null!=c&&(t._collapsed_width=Math.min(t.size[0],e.measureText(c).width+2*n.NODE_TITLE_HEIGHT),l[0]=t._collapsed_width,l[1]=0)}t.clip_area&&(e.save(),e.beginPath(),a==n.BOX_SHAPE?e.rect(0,0,l[0],l[1]):a==n.ROUND_SHAPE?e.roundRect(0,0,l[0],l[1],10):a==n.CIRCLE_SHAPE&&e.arc(.5*l[0],.5*l[1],.5*l[0],0,2*Math.PI),e.clip()),t.has_errors&&(s="red"),this.drawNodeShape(t,e,l,i,s,t.is_selected,t.mouseOver),e.shadowColor="transparent",t.onDrawForeground&&t.onDrawForeground(e,this,this.canvas),e.textAlign=u?"center":"left",e.font=this.inner_text_font;var p=!o,d=this.connecting_output;e.lineWidth=1;var g=0,_=new Float32Array(2);if(t.flags.collapsed){if(this.render_collapsed_slots){var f=null,v=null;if(t.inputs)for(b=0;b<t.inputs.length;b++){if(null!=(E=t.inputs[b]).link){f=E;break}}if(t.outputs)for(b=0;b<t.outputs.length;b++){(E=t.outputs[b]).links&&E.links.length&&(v=E)}if(f){var m=0,y=-.5*n.NODE_TITLE_HEIGHT;u&&(m=.5*t._collapsed_width,y=-n.NODE_TITLE_HEIGHT),e.fillStyle="#686",e.beginPath(),E.type===n.EVENT||E.shape===n.BOX_SHAPE?e.rect(m-7+.5,y-4,14,8):E.shape===n.ARROW_SHAPE?(e.moveTo(m+8,y),e.lineTo(m+-4,y-4),e.lineTo(m+-4,y+4),e.closePath()):e.arc(m,y,4,0,2*Math.PI),e.fill()}if(v){m=t._collapsed_width,y=-.5*n.NODE_TITLE_HEIGHT;u&&(m=.5*t._collapsed_width,y=0),e.fillStyle="#686",e.strokeStyle="black",e.beginPath(),E.type===n.EVENT||E.shape===n.BOX_SHAPE?e.rect(m-7+.5,y-4,14,8):E.shape===n.ARROW_SHAPE?(e.moveTo(m+6,y),e.lineTo(m-6,y-4),e.lineTo(m-6,y+4),e.closePath()):e.arc(m,y,4,0,2*Math.PI),e.fill()}}}else{if(t.inputs)for(var b=0;b<t.inputs.length;b++){var E=t.inputs[b];if(e.globalAlpha=r,this.connecting_node&&!n.isValidConnection(E.type,d.type)&&(e.globalAlpha=.4*r),e.fillStyle=null!=E.link?E.color_on||this.default_connection_color.input_on:E.color_off||this.default_connection_color.input_off,(T=t.getConnectionPos(!0,b,_))[0]-=t.pos[0],T[1]-=t.pos[1],g<T[1]+.5*n.NODE_SLOT_HEIGHT&&(g=T[1]+.5*n.NODE_SLOT_HEIGHT),e.beginPath(),E.type===n.EVENT||E.shape===n.BOX_SHAPE?u?e.rect(T[0]-5+.5,T[1]-8+.5,10,14):e.rect(T[0]-6+.5,T[1]-5+.5,14,10):E.shape===n.ARROW_SHAPE?(e.moveTo(T[0]+8,T[1]+.5),e.lineTo(T[0]-4,T[1]+6+.5),e.lineTo(T[0]-4,T[1]-6+.5),e.closePath()):o?e.rect(T[0]-4,T[1]-4,8,8):e.arc(T[0],T[1],4,0,2*Math.PI),e.fill(),p)(w=null!=E.label?E.label:E.name)&&(e.fillStyle=n.NODE_TEXT_COLOR,u||E.dir==n.UP?e.fillText(w,T[0],T[1]-10):e.fillText(w,T[0]+10,T[1]+5))}if(this.connecting_node&&(e.globalAlpha=.4*r),e.textAlign=u?"center":"right",e.strokeStyle="black",t.outputs)for(var b=0;b<t.outputs.length;b++){var T,w,E=t.outputs[b];if((T=t.getConnectionPos(!1,b,_))[0]-=t.pos[0],T[1]-=t.pos[1],g<T[1]+.5*n.NODE_SLOT_HEIGHT&&(g=T[1]+.5*n.NODE_SLOT_HEIGHT),e.fillStyle=E.links&&E.links.length?E.color_on||this.default_connection_color.output_on:E.color_off||this.default_connection_color.output_off,e.beginPath(),E.type===n.EVENT||E.shape===n.BOX_SHAPE?u?e.rect(T[0]-5+.5,T[1]-8+.5,10,14):e.rect(T[0]-6+.5,T[1]-5+.5,14,10):E.shape===n.ARROW_SHAPE?(e.moveTo(T[0]+8,T[1]+.5),e.lineTo(T[0]-4,T[1]+6+.5),e.lineTo(T[0]-4,T[1]-6+.5),e.closePath()):o?e.rect(T[0]-4,T[1]-4,8,8):e.arc(T[0],T[1],4,0,2*Math.PI),e.fill(),o||e.stroke(),p)(w=null!=E.label?E.label:E.name)&&(e.fillStyle=n.NODE_TEXT_COLOR,u||E.dir==n.DOWN?e.fillText(w,T[0],T[1]-8):e.fillText(w,T[0]-10,T[1]+5))}if(e.textAlign="left",e.globalAlpha=1,t.widgets){var C=g;(u||t.widgets_up)&&(C=2),null!=t.widgets_start_y&&(C=t.widgets_start_y),this.drawNodeWidgets(t,C,e,this.node_widget&&this.node_widget[0]==t?this.node_widget[1]:null)}}t.clip_area&&e.restore(),e.globalAlpha=1}}},l.prototype.drawLinkTooltip=function(t,e){var n=e._pos;if(t.fillStyle="black",t.beginPath(),t.arc(n[0],n[1],3,0,2*Math.PI),t.fill(),null!=e.data&&(!this.onDrawLinkTooltip||1!=this.onDrawLinkTooltip(t,e,this))){var i=e.data,s=null;if(null!=(s=i.constructor===Number?i.toFixed(2):i.constructor===String?'"'+i+'"':i.constructor===Boolean?String(i):i.toToolTip?i.toToolTip():"["+i.constructor.name+"]")){t.font="14px Courier New";var o=t.measureText(s).width+20;t.shadowColor="black",t.shadowOffsetX=2,t.shadowOffsetY=2,t.shadowBlur=3,t.fillStyle="#454",t.beginPath(),t.roundRect(n[0]-.5*o,n[1]-15-24,o,24,3,3),t.moveTo(n[0]-10,n[1]-15),t.lineTo(n[0]+10,n[1]-15),t.lineTo(n[0],n[1]-5),t.fill(),t.shadowColor="transparent",t.textAlign="center",t.fillStyle="#CEC",t.fillText(s,n[0],n[1]-15-24*.3)}}};var c=new Float32Array(4);l.prototype.drawNodeShape=function(t,e,i,s,o,r,a){e.strokeStyle=s,e.fillStyle=o;var u=n.NODE_TITLE_HEIGHT,h=this.ds.scale<.5,p=t._shape||t.constructor.shape||n.ROUND_SHAPE,d=t.constructor.title_mode,g=!0;d==n.TRANSPARENT_TITLE?g=!1:d==n.AUTOHIDE_TITLE&&a&&(g=!0);var _=c;_[0]=0,_[1]=g?-u:0,_[2]=i[0]+1,_[3]=g?i[1]+u:i[1];var f=e.globalAlpha;if(e.beginPath(),p==n.BOX_SHAPE||h?e.fillRect(_[0],_[1],_[2],_[3]):p==n.ROUND_SHAPE||p==n.CARD_SHAPE?e.roundRect(_[0],_[1],_[2],_[3],this.round_radius,p==n.CARD_SHAPE?0:this.round_radius):p==n.CIRCLE_SHAPE&&e.arc(.5*i[0],.5*i[1],.5*i[0],0,2*Math.PI),e.fill(),t.flags.collapsed||(e.shadowColor="transparent",e.fillStyle="rgba(0,0,0,0.2)",e.fillRect(0,-1,_[2],2)),e.shadowColor="transparent",t.onDrawBackground&&(e.mozImageSmoothingEnabled=!1,e.oImageSmoothingEnabled=!1,e.webkitImageSmoothingEnabled=!1,e.msImageSmoothingEnabled=!1,e.imageSmoothingEnabled=!1,t.onDrawBackground(e,this,this.canvas)),g||d==n.TRANSPARENT_TITLE){if(t.onDrawTitleBar)t.onDrawTitleBar(e,u,i,this.ds.scale,s);else if(d!=n.TRANSPARENT_TITLE&&(t.constructor.title_color||this.render_title_colored)){var v=t.constructor.title_color||s;if(t.flags.collapsed&&(e.shadowColor=n.DEFAULT_SHADOW_COLOR),this.use_gradients){var m=l.gradients[v];m||((m=l.gradients[v]=e.createLinearGradient(0,0,400,0)).addColorStop(0,v),m.addColorStop(1,"#000")),e.fillStyle=m}else e.fillStyle=v;e.beginPath(),p==n.BOX_SHAPE||h?e.rect(0,-u,i[0]+1,u):p!=n.ROUND_SHAPE&&p!=n.CARD_SHAPE||e.roundRect(0,-u,i[0]+1,u,this.round_radius,t.flags.collapsed?this.round_radius:0),e.fill(),e.shadowColor="transparent"}if(t.onDrawTitleBox?t.onDrawTitleBox(e,u,i,this.ds.scale):p==n.ROUND_SHAPE||p==n.CIRCLE_SHAPE||p==n.CARD_SHAPE?(h&&(e.fillStyle="black",e.beginPath(),e.arc(.5*u,-.5*u,6,0,2*Math.PI),e.fill()),e.fillStyle=t.boxcolor||n.NODE_DEFAULT_BOXCOLOR,h?e.fillRect(.5*u-5,-.5*u-5,10,10):(e.beginPath(),e.arc(.5*u,-.5*u,5,0,2*Math.PI),e.fill())):(h&&(e.fillStyle="black",e.fillRect(.5*(u-10)-1,-.5*(u+10)-1,12,12)),e.fillStyle=t.boxcolor||n.NODE_DEFAULT_BOXCOLOR,e.fillRect(.5*(u-10),-.5*(u+10),10,10)),e.globalAlpha=f,t.onDrawTitleText&&t.onDrawTitleText(e,u,i,this.ds.scale,this.title_text_font,r),!h){e.font=this.title_text_font;var y=t.getTitle();if(y)if(e.fillStyle=r?"white":t.constructor.title_text_color||this.node_title_color,t.flags.collapsed){e.textAlign="center";var b=e.measureText(y);e.fillText(y,u+.5*b.width,n.NODE_TITLE_TEXT_Y-u),e.textAlign="left"}else e.textAlign="left",e.fillText(y,u,n.NODE_TITLE_TEXT_Y-u)}t.onDrawTitle&&t.onDrawTitle(e)}r&&(t.onBounding&&t.onBounding(_),d==n.TRANSPARENT_TITLE&&(_[1]-=u,_[3]+=u),e.lineWidth=1,e.globalAlpha=.8,e.beginPath(),p==n.BOX_SHAPE?e.rect(-6+_[0],-6+_[1],12+_[2],12+_[3]):p==n.ROUND_SHAPE||p==n.CARD_SHAPE&&t.flags.collapsed?e.roundRect(-6+_[0],-6+_[1],12+_[2],12+_[3],2*this.round_radius):p==n.CARD_SHAPE?e.roundRect(-6+_[0],-6+_[1],12+_[2],12+_[3],2*this.round_radius,2):p==n.CIRCLE_SHAPE&&e.arc(.5*i[0],.5*i[1],.5*i[0]+6,0,2*Math.PI),e.strokeStyle="#FFF",e.stroke(),e.strokeStyle=s,e.globalAlpha=1)};var p=new Float32Array(4),d=new Float32Array(4),g=new Float32Array(2),_=new Float32Array(2);function f(t,e){return Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1]))}function v(t,e,n,i,s,o){return n<t&&n+s>t&&i<e&&i+o>e}function m(t,e){var n=t[0]+t[2],i=t[1]+t[3],s=e[0]+e[2],o=e[1]+e[3];return!(t[0]>s||t[1]>o||n<e[0]||i<e[1])}function y(t,e){e=e||{},this.options=e;var n=this;e.parentMenu&&(e.parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),e.parentMenu=null):(this.parentMenu=e.parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this)),e.event&&e.event.constructor!==MouseEvent&&e.event.constructor!==CustomEvent&&e.event.constructor!==PointerEvent&&(console.error("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it."),e.event=null);var i=document.createElement("div");function s(t){var n=parseInt(i.style.top);return i.style.top=(n+t.deltaY*e.scroll_speed).toFixed()+"px",t.preventDefault(),!0}if(i.className="litegraph litecontextmenu litemenubar-panel",e.className&&(i.className+=" "+e.className),i.style.minWidth=100,i.style.minHeight=100,i.style.pointerEvents="none",setTimeout((function(){i.style.pointerEvents="auto"}),100),i.addEventListener("mouseup",(function(t){return t.preventDefault(),!0}),!0),i.addEventListener("contextmenu",(function(t){return 2==t.button&&(t.preventDefault(),!1)}),!0),i.addEventListener("mousedown",(function(t){if(2==t.button)return n.close(),t.preventDefault(),!0}),!0),e.scroll_speed||(e.scroll_speed=.1),i.addEventListener("wheel",s,!0),i.addEventListener("mousewheel",s,!0),this.root=i,e.title){var o=document.createElement("div");o.className="litemenu-title",o.innerHTML=e.title,i.appendChild(o)}for(var r in t){var a=t.constructor==Array?t[r]:r;null!=a&&a.constructor!==String&&(a=void 0===a.content?String(a):a.content);var l=t[r];this.addItem(a,l,e)}i.addEventListener("mouseleave",(function(t){n.lock||(i.closing_timer&&clearTimeout(i.closing_timer),i.closing_timer=setTimeout(n.close.bind(n,t),500))})),i.addEventListener("mouseenter",(function(t){i.closing_timer&&clearTimeout(i.closing_timer)}));var u=document;e.event&&(u=e.event.target.ownerDocument),u||(u=document),u.fullscreenElement?u.fullscreenElement.appendChild(i):u.body.appendChild(i);var h=e.left||0,c=e.top||0;if(e.event){if(h=e.event.clientX-10,c=e.event.clientY-10,e.title&&(c-=20),e.parentMenu){var p=e.parentMenu.root.getBoundingClientRect();h=p.left+p.width}var d=document.body.getBoundingClientRect(),g=i.getBoundingClientRect();h>d.width-g.width-10&&(h=d.width-g.width-10),c>d.height-g.height-10&&(c=d.height-g.height-10)}i.style.left=h+"px",i.style.top=c+"px",e.scale&&(i.style.transform="scale("+e.scale+")")}function b(t){this.points=t,this.selected=-1,this.nearest=-1,this.size=null,this.must_update=!0,this.margin=5}l.prototype.drawConnections=function(t){var e=n.getTime(),i=this.visible_area;p[0]=i[0]-20,p[1]=i[1]-20,p[2]=i[2]+40,p[3]=i[3]+40,t.lineWidth=this.connections_width,t.fillStyle="#AAA",t.strokeStyle="#AAA",t.globalAlpha=this.editor_alpha;for(var s=this.graph._nodes,o=0,r=s.length;o<r;++o){var a=s[o];if(a.inputs&&a.inputs.length)for(var l=0;l<a.inputs.length;++l){var u=a.inputs[l];if(u&&null!=u.link){var h=u.link,c=this.graph.links[h];if(c){var f=this.graph.getNodeById(c.origin_id);if(null!=f){var v=c.origin_slot,y=null;y=-1==v?[f.pos[0]+10,f.pos[1]+10]:f.getConnectionPos(!1,v,g);var b=a.getConnectionPos(!0,l,_);if(d[0]=y[0],d[1]=y[1],d[2]=b[0]-y[0],d[3]=b[1]-y[1],d[2]<0&&(d[0]+=d[2],d[2]=Math.abs(d[2])),d[3]<0&&(d[1]+=d[3],d[3]=Math.abs(d[3])),m(d,p)){var E=f.outputs[v],T=a.inputs[l];if(E&&T){var w=E.dir||(f.horizontal?n.DOWN:n.RIGHT),C=T.dir||(a.horizontal?n.UP:n.LEFT);if(this.renderLink(t,y,b,c,!1,0,null,w,C),c&&c._last_time&&e-c._last_time<1e3){var O=2-.002*(e-c._last_time),k=t.globalAlpha;t.globalAlpha=k*O,this.renderLink(t,y,b,c,!0,O,"white",w,C),t.globalAlpha=k}}}}}}}}t.globalAlpha=1},l.prototype.renderLink=function(t,e,i,s,o,r,a,u,h,c){s&&this.visible_links.push(s),!a&&s&&(a=s.color||l.link_type_colors[s.type]),a||(a=this.default_link_color),null!=s&&this.highlighted_links[s.id]&&(a="#FFF"),u=u||n.RIGHT,h=h||n.LEFT;var p=f(e,i);this.render_connections_border&&this.ds.scale>.6&&(t.lineWidth=this.connections_width+4),t.lineJoin="round",(c=c||1)>1&&(t.lineWidth=.5),t.beginPath();for(var d=0;d<c;d+=1){var g=5*(d-.5*(c-1));if(this.links_render_mode==n.SPLINE_LINK){t.moveTo(e[0],e[1]+g);var _=0,v=0,m=0,y=0;switch(u){case n.LEFT:_=-.25*p;break;case n.RIGHT:_=.25*p;break;case n.UP:v=-.25*p;break;case n.DOWN:v=.25*p}switch(h){case n.LEFT:m=-.25*p;break;case n.RIGHT:m=.25*p;break;case n.UP:y=-.25*p;break;case n.DOWN:y=.25*p}t.bezierCurveTo(e[0]+_,e[1]+v+g,i[0]+m,i[1]+y+g,i[0],i[1]+g)}else if(this.links_render_mode==n.LINEAR_LINK){t.moveTo(e[0],e[1]+g);_=0,v=0,m=0,y=0;switch(u){case n.LEFT:_=-1;break;case n.RIGHT:_=1;break;case n.UP:v=-1;break;case n.DOWN:v=1}switch(h){case n.LEFT:m=-1;break;case n.RIGHT:m=1;break;case n.UP:y=-1;break;case n.DOWN:y=1}t.lineTo(e[0]+15*_,e[1]+15*v+g),t.lineTo(i[0]+15*m,i[1]+15*y+g),t.lineTo(i[0],i[1]+g)}else{if(this.links_render_mode!=n.STRAIGHT_LINK)return;t.moveTo(e[0],e[1]);var b=e[0],E=e[1],T=i[0],w=i[1];u==n.RIGHT?b+=10:E+=10,h==n.LEFT?T-=10:w-=10,t.lineTo(b,E),t.lineTo(.5*(b+T),E),t.lineTo(.5*(b+T),w),t.lineTo(T,w),t.lineTo(i[0],i[1])}}this.render_connections_border&&this.ds.scale>.6&&!o&&(t.strokeStyle="rgba(0,0,0,0.5)",t.stroke()),t.lineWidth=this.connections_width,t.fillStyle=t.strokeStyle=a,t.stroke();var C=this.computeConnectionPoint(e,i,.5,u,h);if(s&&s._pos&&(s._pos[0]=C[0],s._pos[1]=C[1]),this.ds.scale>=.6&&this.highquality_render&&h!=n.CENTER){if(this.render_connection_arrows){var O=this.computeConnectionPoint(e,i,.25,u,h),k=this.computeConnectionPoint(e,i,.26,u,h),N=this.computeConnectionPoint(e,i,.75,u,h),A=this.computeConnectionPoint(e,i,.76,u,h),S=0,x=0;this.render_curved_connections?(S=-Math.atan2(k[0]-O[0],k[1]-O[1]),x=-Math.atan2(A[0]-N[0],A[1]-N[1])):x=S=i[1]>e[1]?0:Math.PI,t.save(),t.translate(O[0],O[1]),t.rotate(S),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore(),t.save(),t.translate(N[0],N[1]),t.rotate(x),t.beginPath(),t.moveTo(-5,-3),t.lineTo(0,7),t.lineTo(5,-3),t.fill(),t.restore()}t.beginPath(),t.arc(C[0],C[1],5,0,2*Math.PI),t.fill()}if(r){t.fillStyle=a;for(d=0;d<5;++d){var I=(.001*n.getTime()+.2*d)%1;C=this.computeConnectionPoint(e,i,I,u,h);t.beginPath(),t.arc(C[0],C[1],5,0,2*Math.PI),t.fill()}}},l.prototype.computeConnectionPoint=function(t,e,i,s,o){s=s||n.RIGHT,o=o||n.LEFT;var r=f(t,e),a=t,l=[t[0],t[1]],u=[e[0],e[1]],h=e;switch(s){case n.LEFT:l[0]+=-.25*r;break;case n.RIGHT:l[0]+=.25*r;break;case n.UP:l[1]+=-.25*r;break;case n.DOWN:l[1]+=.25*r}switch(o){case n.LEFT:u[0]+=-.25*r;break;case n.RIGHT:u[0]+=.25*r;break;case n.UP:u[1]+=-.25*r;break;case n.DOWN:u[1]+=.25*r}var c=(1-i)*(1-i)*(1-i),p=(1-i)*(1-i)*3*i,d=3*(1-i)*(i*i),g=i*i*i;return[c*a[0]+p*l[0]+d*u[0]+g*h[0],c*a[1]+p*l[1]+d*u[1]+g*h[1]]},l.prototype.drawExecutionOrder=function(t){t.shadowColor="transparent",t.globalAlpha=.25,t.textAlign="center",t.strokeStyle="white",t.globalAlpha=.75;for(var e=this.visible_nodes,i=0;i<e.length;++i){var s=e[i];t.fillStyle="black",t.fillRect(s.pos[0]-n.NODE_TITLE_HEIGHT,s.pos[1]-n.NODE_TITLE_HEIGHT,n.NODE_TITLE_HEIGHT,n.NODE_TITLE_HEIGHT),0==s.order&&t.strokeRect(s.pos[0]-n.NODE_TITLE_HEIGHT+.5,s.pos[1]-n.NODE_TITLE_HEIGHT+.5,n.NODE_TITLE_HEIGHT,n.NODE_TITLE_HEIGHT),t.fillStyle="#FFF",t.fillText(s.order,s.pos[0]+-.5*n.NODE_TITLE_HEIGHT,s.pos[1]-6)}t.globalAlpha=1},l.prototype.drawNodeWidgets=function(t,e,i,s){if(!t.widgets||!t.widgets.length)return 0;var o=t.size[0],r=t.widgets;e+=2;var a=n.NODE_WIDGET_HEIGHT,l=this.ds.scale>.5;i.save(),i.globalAlpha=this.editor_alpha;for(var u=n.WIDGET_OUTLINE_COLOR,h=n.WIDGET_BGCOLOR,c=n.WIDGET_TEXT_COLOR,p=n.WIDGET_SECONDARY_TEXT_COLOR,d=0;d<r.length;++d){var g=r[d],_=e;switch(g.y&&(_=g.y),g.last_y=_,i.strokeStyle=u,i.fillStyle="#222",i.textAlign="left",g.disabled&&(i.globalAlpha*=.5),g.type){case"button":g.clicked&&(i.fillStyle="#AAA",g.clicked=!1,this.dirty_canvas=!0),i.fillRect(15,_,o-30,a),l&&i.strokeRect(15,_,o-30,a),l&&(i.textAlign="center",i.fillStyle=c,i.fillText(g.name,.5*o,_+.7*a));break;case"toggle":i.textAlign="left",i.strokeStyle=u,i.fillStyle=h,i.beginPath(),l?i.roundRect(15,e,o-30,a,.5*a):i.rect(15,e,o-30,a),i.fill(),l&&i.stroke(),i.fillStyle=g.value?"#89A":"#333",i.beginPath(),i.arc(o-30,_+.5*a,.36*a,0,2*Math.PI),i.fill(),l&&(i.fillStyle=p,null!=g.name&&i.fillText(g.name,30,_+.7*a),i.fillStyle=g.value?c:p,i.textAlign="right",i.fillText(g.value?g.options.on||"true":g.options.off||"false",o-40,_+.7*a));break;case"slider":i.fillStyle=h,i.fillRect(15,_,o-30,a);var f=g.options.max-g.options.min,v=(g.value-g.options.min)/f;if(i.fillStyle=s==g?"#89A":"#678",i.fillRect(15,_,v*(o-30),a),l&&i.strokeRect(15,_,o-30,a),g.marker){var m=(g.marker-g.options.min)/f;i.fillStyle="#AA9",i.fillRect(15+m*(o-30),_,2,a)}l&&(i.textAlign="center",i.fillStyle=c,i.fillText(g.name+"  "+Number(g.value).toFixed(3),.5*o,_+.7*a));break;case"number":case"combo":i.textAlign="left",i.strokeStyle=u,i.fillStyle=h,i.beginPath(),l?i.roundRect(15,e,o-30,a,.5*a):i.rect(15,e,o-30,a),i.fill(),l&&(i.stroke(),i.fillStyle=c,i.beginPath(),i.moveTo(31,e+5),i.lineTo(21,e+.5*a),i.lineTo(31,e+a-5),i.fill(),i.beginPath(),i.moveTo(o-15-16,e+5),i.lineTo(o-15-6,e+.5*a),i.lineTo(o-15-16,e+a-5),i.fill(),i.fillStyle=p,i.fillText(g.name,35,_+.7*a),i.fillStyle=c,i.textAlign="right","number"==g.type?i.fillText(Number(g.value).toFixed(void 0!==g.options.precision?g.options.precision:3),o-30-20,_+.7*a):i.fillText(g.value,o-30-20,_+.7*a));break;case"string":case"text":i.textAlign="left",i.strokeStyle=u,i.fillStyle=h,i.beginPath(),l?i.roundRect(15,e,o-30,a,.5*a):i.rect(15,e,o-30,a),i.fill(),l&&(i.stroke(),i.fillStyle=p,null!=g.name&&i.fillText(g.name,30,_+.7*a),i.fillStyle=c,i.textAlign="right",i.fillText(g.value,o-30,_+.7*a));break;default:g.draw&&g.draw(i,t,g,_,a)}e+=a+4,i.globalAlpha=this.editor_alpha}i.restore(),i.textAlign="left"},l.prototype.processNodeWidgets=function(t,e,i,s){if(!t.widgets||!t.widgets.length)return null;for(var o=e[0]-t.pos[0],r=e[1]-t.pos[1],a=t.size[0],l=this,u=this.getCanvasWindow(),h=0;h<t.widgets.length;++h){var c=t.widgets[h];if(!c.disabled&&(c==s||o>6&&o<a-12&&r>c.last_y&&r<c.last_y+n.NODE_WIDGET_HEIGHT)){switch(c.type){case"button":if("mousemove"===i.type)break;c.callback&&setTimeout((function(){c.callback(c,l,t,e,i)}),20),c.clicked=!0,this.dirty_canvas=!0;break;case"slider":c.options.max,c.options.min;var p=Math.clamp((o-10)/(a-20),0,1);c.value=c.options.min+(c.options.max-c.options.min)*p,c.callback&&setTimeout((function(){v(c,c.value)}),20),this.dirty_canvas=!0;break;case"number":case"combo":var d=c.value;if("mousemove"==i.type&&"number"==c.type)c.value+=.1*i.deltaX*(c.options.step||1),null!=c.options.min&&c.value<c.options.min&&(c.value=c.options.min),null!=c.options.max&&c.value>c.options.max&&(c.value=c.options.max);else if("mousedown"==i.type){var g=c.options.values;g&&g.constructor===Function&&(g=c.options.values(c,t));var _=o<40?-1:o>a-40?1:0;if("number"==c.type)c.value+=.1*_*(c.options.step||1),null!=c.options.min&&c.value<c.options.min&&(c.value=c.options.min),null!=c.options.max&&c.value>c.options.max&&(c.value=c.options.max);else if(_){var f=g.indexOf(c.value)+_;f>=g.length&&(f=0),f<0&&(f=g.length-1),c.value=g[f]}else new n.ContextMenu(g,{scale:Math.max(1,this.ds.scale),event:i,className:"dark",callback:function(t,e,n){return this.value=t,v(this,t),l.dirty_canvas=!0,!1}.bind(c)},u)}d!=c.value&&setTimeout(function(){v(this,this.value)}.bind(c),20),this.dirty_canvas=!0;break;case"toggle":"mousedown"==i.type&&(c.value=!c.value,setTimeout((function(){v(c,c.value)}),20));break;case"string":case"text":"mousedown"==i.type&&this.prompt("Value",c.value,function(t){this.value=t,v(this,t)}.bind(c),i);break;default:c.mouse&&c.mouse(ctx,i,[o,r],t)}return c}}function v(n,s){n.value=s,n.options&&n.options.property&&void 0!==t.properties[n.options.property]&&t.setProperty(n.options.property,s),n.callback&&n.callback(n.value,l,t,e,i)}return null},l.prototype.drawGroups=function(t,e){if(this.graph){var i=this.graph._groups;e.save(),e.globalAlpha=.5*this.editor_alpha;for(var s=0;s<i.length;++s){var o=i[s];if(m(this.visible_area,o._bounding)){e.fillStyle=o.color||"#335",e.strokeStyle=o.color||"#335";var r=o._pos,a=o._size;e.globalAlpha=.25*this.editor_alpha,e.beginPath(),e.rect(r[0]+.5,r[1]+.5,a[0],a[1]),e.fill(),e.globalAlpha=this.editor_alpha,e.stroke(),e.beginPath(),e.moveTo(r[0]+a[0],r[1]+a[1]),e.lineTo(r[0]+a[0]-10,r[1]+a[1]),e.lineTo(r[0]+a[0],r[1]+a[1]-10),e.fill();var l=o.font_size||n.DEFAULT_GROUP_FONT_SIZE;e.font=l+"px Arial",e.fillText(o.title,r[0]+4,r[1]+l)}}e.restore()}},l.prototype.adjustNodesSize=function(){for(var t=this.graph._nodes,e=0;e<t.length;++e)t[e].size=t[e].computeSize();this.setDirty(!0,!0)},l.prototype.resize=function(t,e){if(!t&&!e){var n=this.canvas.parentNode;t=n.offsetWidth,e=n.offsetHeight}this.canvas.width==t&&this.canvas.height==e||(this.canvas.width=t,this.canvas.height=e,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))},l.prototype.switchLiveMode=function(t){if(!t)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var e=this,n=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var i=setInterval((function(){e.editor_alpha*=n,e.dirty_canvas=!0,e.dirty_bgcanvas=!0,n<1&&e.editor_alpha<.01&&(clearInterval(i),n<1&&(e.live_mode=!0)),n>1&&e.editor_alpha>.99&&(clearInterval(i),e.editor_alpha=1)}),1)},l.prototype.onNodeSelectionChange=function(t){},l.prototype.touchHandler=function(t){var e=t.changedTouches[0],n="";switch(t.type){case"touchstart":n="mousedown";break;case"touchmove":n="mousemove";break;case"touchend":n="mouseup";break;default:return}var i=this.getCanvasWindow(),s=i.document.createEvent("MouseEvent");s.initMouseEvent(n,!0,!0,i,1,e.screenX,e.screenY,e.clientX,e.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(s),t.preventDefault()},l.onGroupAdd=function(t,e,i){var s=l.active_canvas,o=(s.getCanvasWindow(),new n.LGraphGroup);o.pos=s.convertEventToCanvasOffset(i),s.graph.add(o)},l.onMenuAdd=function(t,e,i,s,o){var r=l.active_canvas,a=r.getCanvasWindow(),u=n.getNodeTypesCategories(r.filter),h=[];for(var c in u)u[c]&&h.push({value:u[c],content:u[c],has_submenu:!0});var p=new n.ContextMenu(h,{event:i,callback:function(t,e,i){var s=t.value,o=n.getNodeTypesInCategory(s,r.filter),l=[];for(var u in o)o[u].skip_list||l.push({content:o[u].title,value:o[u].type});return new n.ContextMenu(l,{event:i,callback:d,parentMenu:p},a),!1},parentMenu:s},a);function d(t,e){var i=s.getFirstEvent(),a=n.createNode(t.value);a&&(a.pos=r.convertEventToCanvasOffset(i),r.graph.add(a)),o&&o(a)}return!1},l.onMenuCollapseAll=function(){},l.onMenuNodeEdit=function(){},l.showMenuNodeOptionalInputs=function(t,e,i,s,o){if(o){var r=this,a=l.active_canvas.getCanvasWindow();e=o.optional_inputs;o.onGetInputs&&(e=o.onGetInputs());var u=[];if(e)for(var h in e){var c=e[h];if(c){var p=c[0];c[2]&&c[2].label&&(p=c[2].label);var d={content:p,value:c};c[1]==n.ACTION&&(d.className="event"),u.push(d)}else u.push(null)}if(this.onMenuNodeInputs&&(u=this.onMenuNodeInputs(u)),u.length){new n.ContextMenu(u,{event:i,callback:function(t,e,n){if(!o)return;t.callback&&t.callback.call(r,o,t,e,n);t.value&&(o.addInput(t.value[0],t.value[1],t.value[2]),o.setDirtyCanvas(!0,!0))},parentMenu:s,node:o},a);return!1}}},l.showMenuNodeOptionalOutputs=function(t,e,i,s,o){if(o){var r=this,a=l.active_canvas.getCanvasWindow();e=o.optional_outputs;o.onGetOutputs&&(e=o.onGetOutputs());var u=[];if(e)for(var h in e){var c=e[h];if(c){if(!o.flags||!o.flags.skip_repeated_outputs||-1==o.findOutputSlot(c[0])){var p=c[0];c[2]&&c[2].label&&(p=c[2].label);var d={content:p,value:c};c[1]==n.EVENT&&(d.className="event"),u.push(d)}}else u.push(null)}if(this.onMenuNodeOutputs&&(u=this.onMenuNodeOutputs(u)),u.length){new n.ContextMenu(u,{event:i,callback:function t(e,i,a){if(!o)return;e.callback&&e.callback.call(r,o,e,i,a);if(!e.value)return;var l=e.value[1];if(l&&(l.constructor===Object||l.constructor===Array)){var u=[];for(var h in l)u.push({content:h,value:l[h]});return new n.ContextMenu(u,{event:i,callback:t,parentMenu:s,node:o}),!1}o.addOutput(e.value[0],e.value[1],e.value[2]),o.setDirtyCanvas(!0,!0)},parentMenu:s,node:o},a);return!1}}},l.onShowMenuNodeProperties=function(t,e,i,s,o){if(o&&o.properties){var r=l.active_canvas,a=r.getCanvasWindow(),u=[];for(var h in o.properties){"object"==typeof(t=void 0!==o.properties[h]?o.properties[h]:" ")&&(t=JSON.stringify(t)),t=l.decodeHTML(t),u.push({content:"<span class='property_name'>"+h+"</span><span class='property_value'>"+t+"</span>",value:h})}if(u.length){new n.ContextMenu(u,{event:i,callback:function(t,e,n,i){if(!o)return;var s=this.getBoundingClientRect();r.showEditPropertyValue(o,t.value,{position:[s.left,s.top]})},parentMenu:s,allow_html:!0,node:o},a);return!1}}},l.decodeHTML=function(t){var e=document.createElement("div");return e.innerText=t,e.innerHTML},l.onResizeNode=function(t,e,n,i,s){s&&(s.size=s.computeSize(),s.setDirtyCanvas(!0,!0))},l.prototype.showLinkMenu=function(t,e){var i=this;console.log(t);var s=new n.ContextMenu(["Add Node",null,"Delete"],{event:e,title:null!=t.data?t.data.constructor.name:null,callback:function(e,n,o){switch(e){case"Add Node":l.onMenuAdd(null,null,o,s,(function(e){console.log("node autoconnect");var n=i.graph.getNodeById(t.origin_id),s=i.graph.getNodeById(t.target_id);e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&n.outputs[t.origin_slot].type==e.inputs[0].type&&e.outputs[0].type==s.inputs[0].type&&(n.connect(t.origin_slot,e,0),e.connect(0,s,t.target_slot),e.pos[0]-=.5*e.size[0])}));break;case"Delete":i.graph.removeLink(t.id)}}});return!1},l.onShowPropertyEditor=function(t,e,n,i,s){var o=t.property||"title",r=s[o],a=document.createElement("div");a.className="graphdialog",a.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",a.querySelector(".name").innerText=o;var u=a.querySelector("input");u&&(u.value=r,u.addEventListener("blur",(function(t){this.focus()})),u.addEventListener("keydown",(function(t){13==t.keyCode&&(g(),t.preventDefault(),t.stopPropagation())})));var h=l.active_canvas.canvas,c=h.getBoundingClientRect(),p=-20,d=-20;function g(){!function(e){"Number"==t.type?e=Number(e):"Boolean"==t.type&&(e=Boolean(e));s[o]=e,a.parentNode&&a.parentNode.removeChild(a);s.setDirtyCanvas(!0,!0)}(u.value)}c&&(p-=c.left,d-=c.top),event?(a.style.left=event.clientX+p+"px",a.style.top=event.clientY+d+"px"):(a.style.left=.5*h.width+p+"px",a.style.top=.5*h.height+d+"px"),a.querySelector("button").addEventListener("click",g),h.parentNode.appendChild(a)},l.prototype.prompt=function(t,e,n,i){var s=this;t=t||"";var o=!1,r=document.createElement("div");r.className="graphdialog rounded",r.innerHTML="<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",r.close=function(){s.prompt_box=null,r.parentNode&&r.parentNode.removeChild(r)},this.ds.scale>1&&(r.style.transform="scale("+this.ds.scale+")"),r.addEventListener("mouseleave",(function(t){o||r.close()})),s.prompt_box&&s.prompt_box.close(),s.prompt_box=r;r.querySelector(".name").innerText=t,r.querySelector(".value").value=e;var a=r.querySelector("input");a.addEventListener("keydown",(function(t){if(o=!0,27==t.keyCode)r.close();else{if(13!=t.keyCode)return;n&&n(this.value),r.close()}t.preventDefault(),t.stopPropagation()})),r.querySelector("button").addEventListener("click",(function(t){n&&n(a.value),s.setDirty(!0),r.close()}));var u=l.active_canvas.canvas,h=u.getBoundingClientRect(),c=-20,p=-20;return h&&(c-=h.left,p-=h.top),i?(r.style.left=i.clientX+c+"px",r.style.top=i.clientY+p+"px"):(r.style.left=.5*u.width+c+"px",r.style.top=.5*u.height+p+"px"),u.parentNode.appendChild(r),setTimeout((function(){a.focus()}),10),r},l.search_limit=-1,l.prototype.showSearchBox=function(t){var e=this,i=l.active_canvas,s=i.canvas,o=s.ownerDocument||document,r=document.createElement("div");r.className="litegraph litesearchbox graphdialog rounded",r.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/><div class='helper'></div>",r.close=function(){e.search_box=null,o.body.focus(),o.body.style.overflow="",setTimeout((function(){e.canvas.focus()}),20),r.parentNode&&r.parentNode.removeChild(r)};var a=null;this.ds.scale>1&&(r.style.transform="scale("+this.ds.scale+")"),r.addEventListener("mouseenter",(function(t){a&&(clearTimeout(a),a=null)})),r.addEventListener("mouseleave",(function(t){a=setTimeout((function(){r.close()}),500)})),e.search_box&&e.search_box.close(),e.search_box=r;var u=r.querySelector(".helper"),h=null,c=null,p=null,d=r.querySelector("input");d&&(d.addEventListener("blur",(function(t){this.focus()})),d.addEventListener("keydown",(function(t){if(38==t.keyCode)m(!1);else if(40==t.keyCode)m(!0);else if(27==t.keyCode)r.close();else{if(13!=t.keyCode)return c&&clearInterval(c),void(c=setTimeout(y,10));p?v(p.innerHTML):h?v(h):r.close()}return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!0}))),o.fullscreenElement?o.fullscreenElement.appendChild(r):(o.body.appendChild(r),o.body.style.overflow="hidden");var g=s.getBoundingClientRect(),_=(t?t.clientX:g.left+.5*g.width)-80,f=(t?t.clientY:g.top+.5*g.height)-20;function v(s){if(s)if(e.onSearchBoxSelection)e.onSearchBoxSelection(s,t,i);else{var o=n.searchbox_extras[s.toLowerCase()];o&&(s=o.type);var a=n.createNode(s);if(a&&(a.pos=i.convertEventToCanvasOffset(t),i.graph.add(a)),o&&o.data){if(o.data.properties)for(var l in o.data.properties)a.addProperty(l,o.data.properties[l]);if(o.data.inputs)for(var l in a.inputs=[],o.data.inputs)a.addOutput(o.data.inputs[l][0],o.data.inputs[l][1]);if(o.data.outputs)for(var l in a.outputs=[],o.data.outputs)a.addOutput(o.data.outputs[l][0],o.data.outputs[l][1]);o.data.title&&(a.title=o.data.title),o.data.json&&a.configure(o.data.json)}}r.close()}function m(t){var e=p;p&&p.classList.remove("selected"),p?(p=t?p.nextSibling:p.previousSibling)||(p=e):p=t?u.childNodes[0]:u.childNodes[u.childNodes.length],p&&(p.classList.add("selected"),p.scrollIntoView({block:"end",behavior:"smooth"}))}function y(){c=null;var t=d.value;if(h=null,u.innerHTML="",t)if(e.onSearchBox){var s=e.onSearchBox(u,t,i);if(s)for(var o=0;o<s.length;++o)m(s[o])}else{var r=function(e){var i=n.registered_node_types[e];return(!p||i.filter==p)&&-1!==e.toLowerCase().indexOf(t)},a=0;t=t.toLowerCase();var p=i.filter||i.graph.filter;for(var o in n.searchbox_extras){var g=n.searchbox_extras[o];if(-1!==g.desc.toLowerCase().indexOf(t)){var _=n.registered_node_types[g.type];if((!_||!_.filter||_.filter==p)&&(m(g.desc,"searchbox_extra"),-1!==l.search_limit&&a++>l.search_limit))break}}var f=null;if(Array.prototype.filter)f=Object.keys(n.registered_node_types).filter(r);else for(var o in f=[],n.registered_node_types)r(o)&&f.push(o);for(o=0;o<f.length&&(m(f[o]),!(-1!==l.search_limit&&a++>l.search_limit));o++);}function m(t,e){var n=document.createElement("div");h||(h=t),n.innerText=t,n.dataset.type=escape(t),n.className="litegraph lite-search-item",e&&(n.className+=" "+e),n.addEventListener("click",(function(t){v(unescape(this.dataset.type))})),u.appendChild(n)}}return r.style.left=_+"px",r.style.top=f+"px",t.layerY>g.height-200&&(u.style.maxHeight=g.height-t.layerY-20+"px"),d.focus(),r},l.prototype.showEditPropertyValue=function(t,e,n){if(t&&void 0!==t.properties[e]){n=n||{};var i="string";null!==t.properties[e]&&(i=typeof t.properties[e]);var s=null;if(t.getPropertyInfo&&(s=t.getPropertyInfo(e)),t.properties_info)for(var o=0;o<t.properties_info.length;++o)if(t.properties_info[o].name==e){s=t.properties_info[o];break}void 0!==s&&null!==s&&s.type&&(i=s.type);var r="";if("string"==i||"number"==i||"array"==i||"object"==i)r="<input autofocus type='text' class='value'/>";else if("enum"==i&&s.values){for(var o in r="<select autofocus type='text' class='value'>",s.values){r+="<option value='"+(u=s.values.constructor===Array?s.values[o]:o)+"' "+(u==t.properties[e]?"selected":"")+">"+s.values[o]+"</option>"}r+="</select>"}else{if("boolean"!=i)return void console.warn("unknown type: "+i);r="<input autofocus type='checkbox' class='value' "+(t.properties[e]?"checked":"")+"/>"}var a=this.createDialog("<span class='name'>"+e+"</span>"+r+"<button>OK</button>",n);if("enum"==i&&s.values)(l=a.querySelector("select")).addEventListener("change",(function(t){c(t.target.value)}));else if("boolean"==i){(l=a.querySelector("input"))&&l.addEventListener("click",(function(t){c(!!l.checked)}))}else{var l;if(l=a.querySelector("input")){l.addEventListener("blur",(function(t){this.focus()}));var u=void 0!==t.properties[e]?t.properties[e]:"";u=JSON.stringify(u),l.value=u,l.addEventListener("keydown",(function(t){13==t.keyCode&&(h(),t.preventDefault(),t.stopPropagation())}))}}a.querySelector("button").addEventListener("click",h)}function h(){c(l.value)}function c(n){"number"==typeof t.properties[e]&&(n=Number(n)),"array"!=i&&"object"!=i||(n=JSON.parse(n)),t.properties[e]=n,t._graph&&t._graph._version++,t.onPropertyChanged&&t.onPropertyChanged(e,n),a.close(),t.setDirtyCanvas(!0,!0)}},l.prototype.createDialog=function(t,e){e=e||{};var n=document.createElement("div");n.className="graphdialog",n.innerHTML=t;var i=this.canvas.getBoundingClientRect(),s=-20,o=-20;return i&&(s-=i.left,o-=i.top),e.position?(s+=e.position[0],o+=e.position[1]):e.event?(s+=e.event.clientX,o+=e.event.clientY):(s+=.5*this.canvas.width,o+=.5*this.canvas.height),n.style.left=s+"px",n.style.top=o+"px",this.canvas.parentNode.appendChild(n),n.close=function(){this.parentNode&&this.parentNode.removeChild(this)},n},l.onMenuNodeCollapse=function(t,e,n,i,s){s.collapse()},l.onMenuNodePin=function(t,e,n,i,s){s.pin()},l.onMenuNodeMode=function(t,e,i,s,o){return new n.ContextMenu(["Always","On Event","On Trigger","Never"],{event:i,callback:function(t){if(!o)return;switch(t){case"On Event":o.mode=n.ON_EVENT;break;case"On Trigger":o.mode=n.ON_TRIGGER;break;case"Never":o.mode=n.NEVER;break;case"Always":default:o.mode=n.ALWAYS}},parentMenu:s,node:o}),!1},l.onMenuNodeColors=function(t,e,i,s,o){if(!o)throw"no node for color";var r=[];for(var a in r.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),l.node_colors){var u=l.node_colors[a];t={value:a,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+u.color+"; background-color:"+u.bgcolor+"'>"+a+"</span>"};r.push(t)}return new n.ContextMenu(r,{event:i,callback:function(t){if(!o)return;var e=t.value?l.node_colors[t.value]:null;e?o.constructor===n.LGraphGroup?o.color=e.groupcolor:(o.color=e.color,o.bgcolor=e.bgcolor):(delete o.color,delete o.bgcolor);o.setDirtyCanvas(!0,!0)},parentMenu:s,node:o}),!1},l.onMenuNodeShapes=function(t,e,i,s,o){if(!o)throw"no node passed";return new n.ContextMenu(n.VALID_SHAPES,{event:i,callback:function(t){if(!o)return;o.shape=t,o.setDirtyCanvas(!0)},parentMenu:s,node:o}),!1},l.onMenuNodeRemove=function(t,e,n,i,s){if(!s)throw"no node passed";!1!==s.removable&&(s.graph.remove(s),s.setDirtyCanvas(!0,!0))},l.onMenuNodeClone=function(t,e,n,i,s){if(0!=s.clonable){var o=s.clone();o&&(o.pos=[s.pos[0]+5,s.pos[1]+5],s.graph.add(o),s.setDirtyCanvas(!0,!0))}},l.node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}},l.prototype.getCanvasMenuOptions=function(){var t=null;if(this.getMenuOptions?t=this.getMenuOptions():(t=[{content:"Add Node",has_submenu:!0,callback:l.onMenuAdd},{content:"Add Group",callback:l.onGroupAdd}],this._graph_stack&&this._graph_stack.length>0&&t.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),this.getExtraMenuOptions){var e=this.getExtraMenuOptions(this,t);e&&(t=t.concat(e))}return t},l.prototype.getNodeMenuOptions=function(t){var e=null;if(e=t.getMenuOptions?t.getMenuOptions(this):[{content:"Inputs",has_submenu:!0,disabled:!0,callback:l.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:l.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:l.onShowMenuNodeProperties},null,{content:"Title",callback:l.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:l.onMenuNodeMode},{content:"Resize",callback:l.onResizeNode},{content:"Collapse",callback:l.onMenuNodeCollapse},{content:"Pin",callback:l.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:l.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:l.onMenuNodeShapes},null],t.onGetInputs){var n=t.onGetInputs();n&&n.length&&(e[0].disabled=!1)}if(t.onGetOutputs){var i=t.onGetOutputs();i&&i.length&&(e[1].disabled=!1)}if(t.getExtraMenuOptions){var s=t.getExtraMenuOptions(this);s&&(s.push(null),e=s.concat(e))}return!1!==t.clonable&&e.push({content:"Clone",callback:l.onMenuNodeClone}),!1!==t.removable&&e.push(null,{content:"Remove",callback:l.onMenuNodeRemove}),t.graph&&t.graph.onGetNodeMenuOptions&&t.graph.onGetNodeMenuOptions(e,t),e},l.prototype.getGroupMenuOptions=function(t){return[{content:"Title",callback:l.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:l.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:l.onShowPropertyEditor},null,{content:"Remove",callback:l.onMenuNodeRemove}]},l.prototype.processContextMenu=function(t,e){var i=this,s=l.active_canvas.getCanvasWindow(),o=null,r={event:e,callback:function(e,n,s){if(!e)return;if("Remove Slot"==e.content)return void((o=e.slot).input?t.removeInput(o.slot):o.output&&t.removeOutput(o.slot));if("Disconnect Links"==e.content)return void((o=e.slot).output?t.disconnectOutput(o.slot):o.input&&t.disconnectInput(o.slot));if("Rename Slot"==e.content){var o,r=(o=e.slot).input?t.getInputInfo(o.slot):t.getOutputInfo(o.slot),a=i.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",n),l=a.querySelector("input");l&&r&&(l.value=r.label||""),a.querySelector("button").addEventListener("click",(function(t){l.value&&(r&&(r.label=l.value),i.setDirty(!0)),a.close()}))}},extra:t};t&&(r.title=t.type);var a=null;if(t&&(a=t.getSlotInPosition(e.canvasX,e.canvasY),l.active_node=t),a){o=[],a&&a.output&&a.output.links&&a.output.links.length&&o.push({content:"Disconnect Links",slot:a});var u=a.input||a.output;o.push(u.locked?"Cannot remove":{content:"Remove Slot",slot:a}),o.push(u.nameLocked?"Cannot rename":{content:"Rename Slot",slot:a}),r.title=(a.input?a.input.type:a.output.type)||"*",a.input&&a.input.type==n.ACTION&&(r.title="Action"),a.output&&a.output.type==n.EVENT&&(r.title="Event")}else if(t)o=this.getNodeMenuOptions(t);else{o=this.getCanvasMenuOptions();var h=this.graph.getGroupOnPos(e.canvasX,e.canvasY);h&&o.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:h,options:this.getGroupMenuOptions(h)}})}if(o)new n.ContextMenu(o,r,s)},this.CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.roundRect=function(t,e,n,i,s,o){void 0===s&&(s=5),void 0===o&&(o=s),this.moveTo(t+s,e),this.lineTo(t+n-s,e),this.quadraticCurveTo(t+n,e,t+n,e+s),this.lineTo(t+n,e+i-o),this.quadraticCurveTo(t+n,e+i,t+n-o,e+i),this.lineTo(t+o,e+i),this.quadraticCurveTo(t,e+i,t,e+i-o),this.lineTo(t,e+s),this.quadraticCurveTo(t,e,t+s,e)}),n.compareObjects=function(t,e){for(var n in t)if(t[n]!=e[n])return!1;return!0},n.distance=f,n.colorToString=function(t){return"rgba("+Math.round(255*t[0]).toFixed()+","+Math.round(255*t[1]).toFixed()+","+Math.round(255*t[2]).toFixed()+","+(4==t.length?t[3].toFixed(2):"1.0")+")"},n.isInsideRectangle=v,n.growBounding=function(t,e,n){e<t[0]?t[0]=e:e>t[2]&&(t[2]=e),n<t[1]?t[1]=n:n>t[3]&&(t[3]=n)},n.isInsideBounding=function(t,e){return!(t[0]<e[0][0]||t[1]<e[0][1]||t[0]>e[1][0]||t[1]>e[1][1])},n.overlapBounding=m,n.hex2num=function(t){"#"==t.charAt(0)&&(t=t.slice(1)),t=t.toUpperCase();for(var e,n,i=new Array(3),s=0,o=0;o<6;o+=2)e="0123456789ABCDEF".indexOf(t.charAt(o)),n="0123456789ABCDEF".indexOf(t.charAt(o+1)),i[s]=16*e+n,s++;return i},n.num2hex=function(t){for(var e,n,i="#",s=0;s<3;s++)e=t[s]/16,n=t[s]%16,i+="0123456789ABCDEF".charAt(e)+"0123456789ABCDEF".charAt(n);return i},y.prototype.addItem=function(t,e,n){var i=this;n=n||{};var s=document.createElement("div");s.className="litemenu-entry submenu";var o=!1;function r(t){var e=this.value,s=!0;(i.current_submenu&&i.current_submenu.close(t),n.callback)&&(!0===n.callback.call(this,e,n,t,i,n.node)&&(s=!1));if(e){if(e.callback&&!n.ignore_item_callbacks&&!0!==e.disabled)!0===e.callback.call(this,e,n,t,i,n.extra)&&(s=!1);if(e.submenu){if(!e.submenu.options)throw"ContextMenu submenu needs options";new i.constructor(e.submenu.options,{callback:e.submenu.callback,event:t,parentMenu:i,ignore_item_callbacks:e.submenu.ignore_item_callbacks,title:e.submenu.title,extra:e.submenu.extra,autoopen:n.autoopen});s=!1}}s&&!i.lock&&i.close()}return null===e?s.classList.add("separator"):(s.innerHTML=e&&e.title?e.title:t,s.value=e,e&&(e.disabled&&(o=!0,s.classList.add("disabled")),(e.submenu||e.has_submenu)&&s.classList.add("has_submenu")),"function"==typeof e?(s.dataset.value=t,s.onclick_callback=e):s.dataset.value=e,e.className&&(s.className+=" "+e.className)),this.root.appendChild(s),o||s.addEventListener("click",r),n.autoopen&&s.addEventListener("mouseenter",(function(t){var e=this.value;if(!e||!e.has_submenu)return;r.call(this,t)})),s},y.prototype.close=function(t,e){this.root.parentNode&&this.root.parentNode.removeChild(this.root),this.parentMenu&&!e&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===t?this.parentMenu.close():t&&!y.isCursorOverElement(t,this.parentMenu.root)&&y.trigger(this.parentMenu.root,"mouseleave",t)),this.current_submenu&&this.current_submenu.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer)},y.trigger=function(t,e,n,i){var s=document.createEvent("CustomEvent");return s.initCustomEvent(e,!0,!0,n),s.srcElement=i,t.dispatchEvent?t.dispatchEvent(s):t.__events&&t.__events.dispatchEvent(s),s},y.prototype.getTopMenu=function(){return this.options.parentMenu?this.options.parentMenu.getTopMenu():this},y.prototype.getFirstEvent=function(){return this.options.parentMenu?this.options.parentMenu.getFirstEvent():this.options.event},y.isCursorOverElement=function(t,e){var n=t.clientX,i=t.clientY,s=e.getBoundingClientRect();return!!s&&(i>s.top&&i<s.top+s.height&&n>s.left&&n<s.left+s.width)},n.ContextMenu=y,n.closeAllContextMenus=function(t){var e=(t=t||window).document.querySelectorAll(".litecontextmenu");if(e.length){for(var n=[],i=0;i<e.length;i++)n.push(e[i]);for(var i in n)n[i].close?n[i].close():n[i].parentNode&&n[i].parentNode.removeChild(n[i])}},n.extendClass=function(t,e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n]);if(e.prototype)for(var n in e.prototype)e.prototype.hasOwnProperty(n)&&(t.prototype.hasOwnProperty(n)||(e.prototype.__lookupGetter__(n)?t.prototype.__defineGetter__(n,e.prototype.__lookupGetter__(n)):t.prototype[n]=e.prototype[n],e.prototype.__lookupSetter__(n)&&t.prototype.__defineSetter__(n,e.prototype.__lookupSetter__(n))))},b.sampleCurve=function(t,e){if(e){for(var n=0;n<e.length-1;++n){var i=e[n],s=e[n+1];if(!(s[0]<t)){var o=s[0]-i[0];if(Math.abs(o)<1e-5)return i[1];var r=(t-i[0])/o;return i[1]*(1-r)+s[1]*r}}return 0}},b.prototype.draw=function(t,e,n,i,s,o){var r=this.points;if(r){this.size=e;var a=e[0]-2*this.margin,l=e[1]-2*this.margin;s=s||"#666",t.save(),t.translate(this.margin,this.margin),i&&(t.fillStyle="#111",t.fillRect(0,0,a,l),t.fillStyle="#222",t.fillRect(.5*a,0,1,l),t.strokeStyle="#333",t.strokeRect(0,0,a,l)),t.strokeStyle=s,o&&(t.globalAlpha=.5),t.beginPath();for(var u=0;u<r.length;++u){var h=r[u];t.lineTo(h[0]*a,(1-h[1])*l)}if(t.stroke(),t.globalAlpha=1,!o)for(u=0;u<r.length;++u){h=r[u];t.fillStyle=this.selected==u?"#FFF":this.nearest==u?"#DDD":"#AAA",t.beginPath(),t.arc(h[0]*a,(1-h[1])*l,2,0,2*Math.PI),t.fill()}t.restore()}},b.prototype.onMouseDown=function(t,e){var n=this.points;if(n&&!(t[1]<0)){var i=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=t[0]-this.margin,r=t[1]-this.margin,a=[o,r],l=30/e.ds.scale;if(this.selected=this.getCloserPoint(a,l),-1==this.selected){var u=[o/i,1-r/s];n.push(u),n.sort((function(t,e){return t[0]-e[0]})),this.selected=n.indexOf(u),this.must_update=!0}return-1!=this.selected||void 0}},b.prototype.onMouseMove=function(t,e){var n=this.points;if(n){var i=this.selected;if(!(i<0)){var s=(t[0]-this.margin)/(this.size[0]-2*this.margin),o=(t[1]-this.margin)/(this.size[1]-2*this.margin),r=[t[0]-this.margin,t[1]-this.margin],a=30/e.ds.scale;this._nearest=this.getCloserPoint(r,a);var l=n[i];if(l){var u=0==i||i==n.length-1;if(!u&&(t[0]<-10||t[0]>this.size[0]+10||t[1]<-10||t[1]>this.size[1]+10))return n.splice(i,1),void(this.selected=-1);l[0]=u?0==i?0:1:Math.clamp(s,0,1),l[1]=1-Math.clamp(o,0,1),n.sort((function(t,e){return t[0]-e[0]})),this.selected=n.indexOf(l),this.must_update=!0}}}},b.prototype.onMouseUp=function(t,e){return this.selected=-1,!1},b.prototype.getCloserPoint=function(t,e){var n=this.points;if(!n)return-1;e=e||30;for(var i=this.size[0]-2*this.margin,s=this.size[1]-2*this.margin,o=n.length,r=[0,0],a=1e6,l=-1,u=0;u<o;++u){var h=n[u];r[0]=h[0]*i,r[1]=(1-h[1])*s,r[0]<t[0]&&u;var c=vec2.distance(t,r);c>a||c>e||(l=u,a=c)}return l},n.CurveEditor=b,n.getParameterNames=function(t){return(t+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)},Math.clamp=function(t,e,n){return e>t?e:n<t?n:t},"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)})}(this),e.LiteGraph=this.LiteGraph}).call(this,n(75))},77:function(t,e,n){"use strict";n.r(e);var i=n(42),s=n(7),o=n(8),r=n(13),a=n(10),l=n(9),u=n(11),h=n(35),c=n(43),p=n.n(c),d=n(0),g=n.n(d),_=n(16),f=n.n(_),v=(n(61),n(62),n(44)),m=n.n(v),y=(n(70),n(71),n(72),n(34)),b=(n(73),n(49)),E=n(82),T=n(81),w=n(30),C=n(83),O=n(45),k=n(1),N=n(46),A=n(47),S=n(48),x=n(74),I=x.LGraph,D=x.LGraphCanvas,R=x.LiteGraph,L=x.LGraphNode,P=function(t,e){return t.size===e.size&&Object(h.a)(t).every((function(t){return e.has(t)}))};function M(t){if(!t){if("undefined"!==typeof Error)throw new Error("Assertion failed");throw"Assertion failed"}}var F={};function B(t){for(var e in F.litegraph.clear(),F.litegraph.configure(t,!1),F._on_reset_table)F._on_reset_table[e]()}F.litegraph=new I,F.on_select=null,F.on_deselect=null,F.litegraph_canvas=null,F._after_table={},F._onselect_table=[],F.exec_after=function(t,e){t in F._after_table||(F._after_table[t]=[]),F._after_table[t].push(e)},F.exec_on_select=function(t,e){F._onselect_table.push({onselect:t,ondeselect:e})},F.exec_selected=function(t){for(var e in F._onselect_table){var n=F._onselect_table[e];for(var i in t)n.onselect(t[i])}},F.exec_deselected=function(t){for(var e in F._onselect_table){var n=F._onselect_table[e];for(var i in t)n.ondeselect(t[i])}},F.exec=function(t){switch(t.type){case"add_src":var e=t.src_name;M(!(e in F.litegraph.config.srcs)),F.litegraph.config.srcs[e]={code:""};break;case"remove_src":var n=t.src_name;M(n in F.litegraph.config.srcs),delete F.litegraph.config.srcs[n];break;default:throw Error("unrecognized command")}if(t.type in F._after_table)for(var i in F._after_table[t.type])F._after_table[t.type][i](t)},F.viewport={width:512,height:512},F._on_reset_table=[],F.on_reset=function(t){F._on_reset_table.push(t)},F.exec_reset=function(){for(var t in F.litegraph.clear(),F.litegraph.config.srcs={},F._on_reset_table)F._on_reset_table[t]()},F.reload=function(){var t=F.litegraph.serialize();for(var e in F.exec_reset(),F.litegraph.configure(t,!1),F._on_reset_table)F._on_reset_table[e]()},F.get_src=function(t){return M(t in F.litegraph.config.srcs),F.litegraph.config.srcs[t].code},F._scr_change_table=[],F.on_src_change=function(t){F._scr_change_table.push(t)},F.set_src=function(t,e){F.litegraph.config.srcs[t].code=e,F._scr_change_table.forEach((function(e){return e(t)}))},F.draw_triangle=function(t){var e="#version 300 es\n      \n      layout (location=0) in vec4 position;\n      layout (location=1) in vec3 color;\n      \n      out vec3 vColor;\n\n      void main() {\n\n          vColor = color;\n          gl_Position = position;\n      }\n      ",n="#version 300 es\n      precision highp float;\n      in vec3 vColor;\n      out vec4 fragColor;\n\n      void main() {\n          fragColor = vec4(vColor, 1.0);\n      }",i=t.createShader(t.VERTEX_SHADER);t.shaderSource(i,e),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)||console.error(t.getShaderInfoLog(i));var s=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(s,n),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS)||console.error(t.getShaderInfoLog(s));var o=t.createProgram();t.attachShader(o,i),t.attachShader(o,s),t.linkProgram(o),t.getProgramParameter(o,t.LINK_STATUS)||console.error(t.getProgramInfoLog(o)),t.useProgram(o);var r=t.createVertexArray();t.bindVertexArray(r);var a=new Float32Array([-.5,-.5,0,.5,-.5,0,0,.5,0]),l=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,l),t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW),t.vertexAttribPointer(0,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(0);var u=new Float32Array([1,0,0,0,1,0,1,0,0]),h=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,h),t.bufferData(t.ARRAY_BUFFER,u,t.STATIC_DRAW),t.vertexAttribPointer(1,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(1),t.disable(t.CULL_FACE),t.frontFace(t.CW),t.disable(t.DEPTH_TEST),t.disable(t.SCISSOR_TEST),t.depthFunc(t.LEQUAL),t.disable(t.BLEND),t.blendFunc(t.ONE,t.ONE),t.drawArrays(t.TRIANGLES,0,3),t.deleteBuffer(l),t.deleteBuffer(h),t.deleteShader(i),t.deleteShader(s),t.deleteProgram(o)},F.render_texture=function(t,e,n){var i=F.gl,s={vs:"#version 300 es\n      precision highp float;\n      in vec2 position;\n      out vec2 uv;\n      void main() {\n        uv = 0.5 * (position + 1.0);\n        uv.y = 1.0 - uv.y;\n        gl_Position = vec4(position, 0, 1);\n      }\n      ",ps:"#version 300 es\n      precision highp float;\n      precision highp int;\n      precision highp usampler2D;\n      precision highp isampler2D;\n      in vec2 uv;\n      uniform sampler2D in_tex;\n      out vec4 fragColor;\n      void main() {\n        fragColor = vec4(vec3(texture(in_tex, uv).xyz), 1.0);\n      }"};if((n=n||!1)&&(s.vs=s.vs.replace("uv.y = 1.0 - uv.y;","uv.y = uv.y;")),e)switch(e){case"RGBA32UI":s.ps=s.ps.replace("uniform sampler2D","uniform usampler2D");break;case"RGBA32F":break;default:throw Error("unknown format")}var o=s.vs,r=s.ps,a=i.createShader(i.VERTEX_SHADER);i.shaderSource(a,o),i.compileShader(a),i.getShaderParameter(a,i.COMPILE_STATUS)||console.error(i.getShaderInfoLog(a));var l=i.createShader(i.FRAGMENT_SHADER);i.shaderSource(l,r),i.compileShader(l),i.getShaderParameter(l,i.COMPILE_STATUS)||console.error(i.getShaderInfoLog(l));var u=i.createProgram();i.attachShader(u,a),i.attachShader(u,l),i.linkProgram(u),i.getProgramParameter(u,i.LINK_STATUS)||console.error(i.getProgramInfoLog(u)),i.useProgram(u);var h=i.createVertexArray();i.bindVertexArray(h);var c=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,c),i.bufferData(i.ARRAY_BUFFER,new Float32Array([-4,-4,4,-4,0,4]),i.STATIC_DRAW),i.vertexAttribPointer(0,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(0),i.activeTexture(i.TEXTURE0+0),i.bindTexture(i.TEXTURE_2D,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.uniform1i(i.getUniformLocation(u,"in_tex"),0),i.drawArrays(i.TRIANGLES,0,3),i.deleteBuffer(c),i.deleteShader(a),i.deleteShader(l),i.deleteProgram(u),i.deleteVertexArray(h)},F.get_texture_data=function(t,e,n,i){var s=F.gl,o=Math.floor(n)||256,r=Math.floor(i)||256,a=s.createTexture();s.bindTexture(s.TEXTURE_2D,a);var l=s.RGBA,u=s.RGBA,h=s.UNSIGNED_BYTE;s.texImage2D(s.TEXTURE_2D,0,l,o,r,0,u,h,null),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);var c=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,c),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,a,0),s.disable(s.CULL_FACE),s.disable(s.DEPTH_TEST),s.disable(s.DEPTH_TEST),s.disable(s.SCISSOR_TEST),s.depthFunc(s.LEQUAL),s.blendFunc(s.ONE,s.ONE),s.bindFramebuffer(s.FRAMEBUFFER,c),s.drawBuffers([s.COLOR_ATTACHMENT0]),s.viewport(0,0,o,r),s.clearColor(0,0,1,1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),F.render_texture(t,e);var p=new Uint8Array(o*r*4);s.readPixels(0,0,o,r,s.RGBA,s.UNSIGNED_BYTE,p),s.deleteFramebuffer(c),s.deleteTexture(a);var d=new Uint8ClampedArray(p);return new ImageData(d,o,r)},F._dirty_set=new Set,F._dirty_deferred_set=new Set,F.set_dirty=function(t){t.is_recursive&&t.is_recursive()?F._dirty_deferred_set.add(t):F._dirty_set.add(t)},F.update=function(){for(var t=new Set(F._dirty_set),e=function(){var e=new Set;if(t.forEach((function(t){t.outputs&&t.outputs.forEach((function(t){t.links&&t.links.forEach((function(t){var n=F.litegraph.links[t],i=F.litegraph.getNodeById(n.target_id);i&&!F._dirty_set.has(i)&&(F._dirty_set.add(i),e.add(i))}))}))})),0==e.size)return"break";t=e};;){if("break"===e())break}for(var n=[],i=new Set,s=0;;){new Set;if(F._dirty_set.forEach((function(t){var e=!1;t.inputs&&t.inputs.forEach((function(t){if(t.link){var n=F.litegraph.getNodeById(t.link.input_id);F._dirty_set.has(n)&&(e=!0)}})),e||(i.add(t),n.push(t))})),i.forEach((function(t){return F._dirty_set.delete(t)})),i.clear(),0==F._dirty_set.size)break;if((s+=1)>1e3)throw Error("[Error] Recursion detected. Exiting loop")}n.forEach((function(t){t.update&&t.update(),t.notify()})),F._dirty_deferred_set.forEach((function(t){t.update&&t.update()})),F._dirty_deferred_set.clear()},F.periodic_update=setInterval(F.update,200),F.toposort=function(){var t=[],e=new Set,n=new Set,i=[];for(F.litegraph._nodes.forEach((function(t){t.is_recursive&&t.is_recursive()||(n.add(t),i.push(t))}));i.length;){var s=i.shift(),o=!0;for(var r in s.inputs){var a=s.inputs[r].link;if(a){var l=F.litegraph.links[a];if(l){var u=F.litegraph.getNodeById(l.origin_id);if(n.has(u)){o=!1;break}}}}o?(t.push(s),e.add(s),n.delete(s)):i.push(s)}return F.litegraph._nodes.forEach((function(e){e.is_recursive&&e.is_recursive()&&t.push(e)})),t},F.frame_count=0,F.draw=function(){var t=F.toposort();t.forEach((function(t){t.gl_init&&t.gl_init(F.gl)})),t.forEach((function(t){t.gl_render&&t.gl_render(F.gl)})),Array.from(t).reverse().forEach((function(t){t.gl_release&&t.gl_release(F.gl)})),F.litegraph_canvas.setDirty(!0),F.frame_count+=1},F.update_thumbnails=function(){F.litegraph_canvas.setDirty(!0)};var G=["default_graph.json","ltc.json","feedback_test.json"],H=function(t){function e(t,n){var i;return Object(o.a)(this,e),(i=Object(a.a)(this,Object(l.a)(e).call(this,t,n))).setShow=function(t){i.setState({visible:t})},i.handleClose=function(){return i.setShow(!1)},i.handleShow=function(){return i.setShow(!0)},i.handleApply=function(){i.props.on_submit(i.myInput.value),i.setShow(!1)},i.state={visible:!1},i.myInput={value:""},i}return Object(u.a)(e,t),Object(r.a)(e,[{key:"render",value:function(){return g.a.createElement(g.a.Fragment,null,g.a.createElement(b.a,{variant:"primary",onClick:this.handleShow},"Load Graph"),g.a.createElement(E.a,{show:this.state.visible,onHide:this.handleClose},g.a.createElement(E.a.Header,{closeButton:!0},g.a.createElement(E.a.Title,null,"Choose source")),g.a.createElement(E.a.Footer,null,g.a.createElement(b.a,{variant:"secondary",onClick:this.handleClose},"Cancel"),g.a.createElement(T.a,{id:"dropdown-item-button",title:"Dropdown button"},G.map((function(t){return g.a.createElement(w.a.Item,{key:t,onClick:function(){fetch(t).then((function(t){return t.text()})).then((function(t){B(JSON.parse(t))}))}},t)}))))))}}]),e}(g.a.Component),U=new O.a,z=function(t){function e(){var t;return Object(o.a)(this,e),(t=Object(a.a)(this,Object(l.a)(e).call(this))).is_recursive=function(){return!1},t.subscribe=function(e){t.subscribers.add(e)},t.unsubscribe=function(e){t.subscribers.delete(e)},t.notify=function(){t.subscribers.forEach((function(t){t.set_dirty&&t.set_dirty()}))},t.set_dirty=function(){F.set_dirty(Object(s.a)(t))},t.onConfigure=function(){t.update&&t.set_dirty()},t.clean_inputs=function(){for(var e=t.inputs.length-1;e>=0;e--)t.removeInput(e)},t.clean_outputs=function(){for(var e=t.outputs.length-1;e>=0;e--)t.removeOutput(e)},t.onRemoved=function(){F._dirty_set.delete(Object(s.a)(t))},t.set_inputs=function(e){var n=new Set;t.inputs.forEach((function(t){return n.add(t.type+" "+t.name)})),P(n,e)||(n.forEach((function(n){e.has(n)||t.removeInputByName(n.split(" ")[1])})),e.forEach((function(e){n.has(e)||t.addInput(e.split(" ")[1],e.split(" ")[0])})))},t.set_outputs=function(e){var n=new Set;t.outputs.forEach((function(t){return n.add(t.type+" "+t.name)})),P(n,e)||(n.forEach((function(n){e.has(n)||t.removeOutputByName(n.split(" ")[1])})),e.forEach((function(e){n.has(e)||t.addOutput(e.split(" ")[1],e.split(" ")[0])})))},t.subscribers=new Set,t}return Object(u.a)(e,t),e}(L),X=function(t){function e(){var t;return Object(o.a)(this,e),(t=Object(a.a)(this,Object(l.a)(e).call(this))).get_value=function(t){return F.frame_count},t.onDrawBackground=function(e){0==F.frame_count?t.outputs[0].label="0":t.outputs[0].label=F.frame_count},t.title="Frame count",t.addWidget("button","reset",null,(function(t){F.frame_count=0}),{}),t.addOutput("0","uniform_t"),t}return Object(u.a)(e,t),e}(z),j=function t(){var e=this;Object(o.a)(this,t),this.init=function(t,n){e.attributes=t,e.indices=n},this.init_gltf=function(t){M("Mesh"==t.type),S.a.computeTangents(t.geometry),e.attributes={},Object.keys(t.geometry.attributes).forEach((function(n){var i=t.geometry.attributes[n],s={};switch(s.data=i.array,M(0==i.normalized),i.itemSize){case 1:s.type="float";break;case 2:s.type="vec2";break;case 3:s.type="vec3";break;case 4:s.type="vec4";break;default:throw Error()}e.attributes[n]=s})),e.indices={},e.indices.data=t.geometry.index.array,e.indices.type="uint16",e.pbr_material=t.material,e.images=[],Object.keys(e.pbr_material).forEach((function(t){e.pbr_material[t]&&"object"==typeof e.pbr_material[t]&&"image"in e.pbr_material[t]&&e.images.push({name:t,img:e.pbr_material[t].image})}))},this.get_attrib_data=function(t){return e.attributes[t]},this.get_index_data=function(){return e.indices}},W=function(t){function e(){var t;Object(o.a)(this,e),(t=Object(a.a)(this,Object(l.a)(e).call(this))).traverse=function(e){if("Mesh"==e.type){var n=new j;n.init_gltf(e),t.meshes.push(n)}else e.children.forEach((function(e){return t.traverse(e)}))},t.get_meshes=function(){return t.meshes},t.display=function(e){var n=document.createElement("canvas"),i=document.createElement("canvas"),s=document.createElement("div");s.appendChild(n),s.style.cssText="margin-top: 16px;";var o,r,a,l=n.getContext("webgl2",{alpha:!1}),u=new k.xb({canvas:n,context:l});(r=new k.U(45,1,.25,20)).position.set(-1.8,.6,2.7),a=new k.gb;var h=function(){var t=e.datgui.domElement.parentNode;t?(n.classList.add("margin_16"),u.setSize(t.offsetWidth-32,t.offsetWidth-32)):u.setSize(512,512),u.render(a,r)},c=new k.T(u);c.compileEquirectangularShader(),(new A.a).setDataType(k.sb).setPath("textures/equirectangular/").load("venice_sunset_1k.hdr",(function(e){var n=c.fromEquirectangular(e).texture;a.background=n,a.environment=n,e.dispose(),c.dispose(),a.add(t.gltf.scene),h()})),u.setPixelRatio(1),u.outputEncoding=k.yb;var p=new k.c;p.setFromObject(t.gltf.scene);var d=p.getSize(),g=Math.max(d.x,d.y,d.z),_=r.fov*(Math.PI/180),f=Math.abs(g/4*Math.tan(2*_));f*=1.25;var v=p.min.z,m=v<0?-v+f:f-v;(o=new N.a(r,u.domElement)).addEventListener("change",h),o.minDistance=g,o.maxDistance=1e3,o.target.set(0,0,0),o.update(),r.aspect=1,r.far=1e3,r.far=3*m,r.updateProjectionMatrix(),u.render(a,r),s.appendChild(i),e.datgui.domElement.appendChild(s),s.width=512},t.title="Model",t.properties={fileurl:null},t.onPropertyChange=function(t,e){},t.addOutput("mesh","mesh_t"),t.meshes=[];return U.load("models/LeePerrySmith/LeePerrySmith.gltf",(function(e){console.log(e),t.gltf=e,t.traverse(e.scene)})),t.yoffset=0,t}return Object(u.a)(e,t),Object(r.a)(e,[{key:"onDrawBackground",value:function(t){this.flags.collapsed}}]),e}(z),Y=function(t){function e(t,n){var i;return Object(o.a)(this,e),(i=Object(a.a)(this,Object(l.a)(e).call(this,t,n))).exec_graph=function(){},i.onResize=function(){i.canvas.width=i.canvas.parentNode.offsetWidth,i.canvas.height=i.canvas.parentNode.offsetHeight},i.graph=new I,i.canvas=null,i}return Object(u.a)(e,t),Object(r.a)(e,[{key:"componentDidMount",value:function(){this.canvas=document.getElementById("myglcanvas"),this.gl=this.canvas.getContext("webgl2",{alpha:!1});var t=this.gl;if(!t.getExtension("EXT_color_buffer_float"))return alert("need EXT_color_buffer_float");F.glcanvas=this.canvas,F.gl=t,F.draw_triangle(t)}},{key:"render",value:function(){return g.a.createElement("canvas",{id:"myglcanvas",style:{width:"100%",height:"100%"}})}}]),e}(g.a.Component),V=function(t){function e(){var t;Object(o.a)(this,e),(t=Object(a.a)(this,Object(l.a)(e).call(this))).gl_render=function(e){var n=t.getInputNodeByName("in");if(n){var i=t.getInputLinkByName("in"),s=n.get_texture(i.origin_slot);t.update_thumbnails();var o=F.glcanvas,r=o.clientWidth,a=o.clientHeight;r&&a&&(o.width==r&&o.height==a||(o.width=r,o.height=a)),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.DEPTH_TEST),e.disable(e.SCISSOR_TEST),e.depthFunc(e.LEQUAL),e.blendFunc(e.ONE,e.ONE),e.bindFramebuffer(e.FRAMEBUFFER,null),e.drawBuffers([e.BACK]),e.viewport(0,0,o.width,o.height),e.clearColor(0,0,1,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),F.render_texture(s,"RGBA32F",!0)}},t.update_thumbnails=function(){var e=t.getInputNodeByName("in");if(e){var n=t.getInputLinkByName("in"),i=e.get_texture(n.origin_slot);t.thumbnail=null;var s=F.get_texture_data(i,"RGBA32F",t.viewport.width,t.viewport.height),o=document.createElement("canvas"),r=o.getContext("2d");o.width=s.width,o.height=s.height,r.putImageData(s,0,0);var a=document.createElement("img");a.src=o.toDataURL("image/png"),t.thumbnail=a,F.update_thumbnails()}},t.addInput("in","uniform_t"),t.properties={},t.title="Back Buffer";var n=F.litegraph.findNodesByType("gfx/BackBufferNode");if(n.length>0)for(var i=0;i<n.length;i++)F.litegraph.remove(n[i]);return t.thumbnail=null,t.viewport={width:128,height:128},t}return Object(u.a)(e,t),Object(r.a)(e,[{key:"onDrawBackground",value:function(t){if(!this.flags.collapsed){var e=this.size[0]-32;this.viewport.width=e,this.viewport.height=e,this.thumbnail?t.drawImage(this.thumbnail,16,16,e,e):t.fillRect(16,16,e,e),this.size[1]=e+32}}}]),e}(z),K=function(t){function e(){var t;return Object(o.a)(this,e),(t=Object(a.a)(this,Object(l.a)(e).call(this))).set_vs=function(e){t.properties.vs=e},t.set_ps=function(e){t.properties.ps=e},t.clean_inputs=function(){for(var e=t.inputs.length-1;e>=0;e--)t.removeInput(e)},t.is_valid=function(){return t.valid},t.get_uniform_location=function(e,n){return e.getUniformLocation(t.gl.program,n)},t.gl_init=function(e){if(!t.is_valid)return!1;M(!("gl"in Object(s.a)(t))),t.gl={vs:null,ps:null,program:null};var n=F.get_src(t.properties.vs);if(t.gl.vs=e.createShader(e.VERTEX_SHADER),e.shaderSource(t.gl.vs,n),e.compileShader(t.gl.vs),!e.getShaderParameter(t.gl.vs,e.COMPILE_STATUS))return console.error(e.getShaderInfoLog(t.gl.vs)),t.gl_release(e),!1;var i=F.get_src(t.properties.ps);return t.gl.ps=e.createShader(e.FRAGMENT_SHADER),e.shaderSource(t.gl.ps,i),e.compileShader(t.gl.ps),e.getShaderParameter(t.gl.ps,e.COMPILE_STATUS)?(t.gl.program=e.createProgram(),e.attachShader(t.gl.program,t.gl.ps),e.attachShader(t.gl.program,t.gl.vs),e.linkProgram(t.gl.program),e.getProgramParameter(t.gl.program,e.LINK_STATUS)?void 0:(console.error(e.getProgramInfoLog(t.gl.program)),t.gl_release(e),!1)):(console.error(e.getShaderInfoLog(t.gl.ps)),t.gl_release(e),!1)},t.bind=function(e){return e.useProgram(t.gl.program),e.disable(e.CULL_FACE),e.frontFace(e.CW),e.depthMask(!0),e.enable(e.DEPTH_TEST),e.disable(e.SCISSOR_TEST),e.depthFunc(e.LEQUAL),e.disable(e.BLEND),e.blendFunc(e.ONE,e.ONE),!0},t.get_attrib_location=function(e,n){return t.gl&&t.gl.program?e.getAttribLocation(t.gl.program,n):null},t.gl_release=function(e){"gl"in Object(s.a)(t)&&(null!=t.gl.vs&&e.deleteShader(t.gl.vs),null!=t.gl.ps&&e.deleteShader(t.gl.ps),null!=t.gl.program&&e.deleteProgram(t.gl.program),delete t.gl)},t.display=function(e){var n=[],i={select_vs:t.properties.vs,select_ps:t.properties.ps};Object.keys(F.litegraph.config.srcs).forEach((function(t){return n.push(t)})),e.datgui.add(i,"select_vs",n).onChange((function(e){return t.set_vs(e)})),e.datgui.add(i,"select_ps",n).onChange((function(e){return t.set_ps(e)}))},t.update=function(){t.parse_shaders()},t.get_info=function(){return t.valid||t.parse_shaders(),{attributes:t.properties.attributes,uniforms:t.properties.uniforms,valid:t.valid}},t.parse_shaders=function(){t.valid=!1;var e=new Set;if(t.properties.attributes=[],t.properties.uniforms=[],null!=t.properties.vs)try{if("undefined"==typeof window.glslang)throw Error("glslang is not ready");for(var n=window.glslang.parse_attributes(F.get_src(t.properties.vs),"vertex"),i=JSON.parse(n),s=0;s<i.attributes.length-1;s++){var o=i.attributes[s];t.properties.attributes.push({name:o.name,type:o.type})}for(s=0;s<i.uniforms.length-1;s++){var r=i.uniforms[s];e.has(r.name)||"_"!=r.name[0]&&(e.add(r.name),t.properties.uniforms.push({name:r.name,type:r.type}))}var a=window.glslang.parse_attributes(F.get_src(t.properties.ps),"fragment"),l=JSON.parse(a);for(s=0;s<l.uniforms.length-1;s++){var u=l.uniforms[s];e.has(u.name)||"_"!=u.name[0]&&(e.add(u.name),t.properties.uniforms.push({name:u.name,type:u.type}))}t.valid=!0}catch(h){return console.log(h),null}},t.properties={vs:null,ps:null,attributes:null,uniforms:null},t.addOutput("out","pipeline_t"),t.title="Pipeline",t.valid=!1,F.exec_after("remove_src",(function(e){e.src_name==t.vs&&t.set_vs(null),e.src_name==t.ps&&t.set_ps(null)})),F.on_src_change((function(e){e==t.properties.vs&&t.set_dirty(),e==t.properties.ps&&t.set_dirty()})),t}return Object(u.a)(e,t),Object(r.a)(e,[{key:"onSelected",value:function(){}},{key:"onDeselected",value:function(){}}]),e}(z),J=function(t){function e(){var t;return Object(o.a)(this,e),(t=Object(a.a)(this,Object(l.a)(e).call(this))).display=function(e){var n=[],i={src:t.properties.src};Object.keys(F.litegraph.config.srcs).forEach((function(t){return n.push(t)})),e.datgui.add(i,"src",n).onChange((function(e){return t.set_src(e)}));var s=e.datgui.addFolder("Attributes");if(t.buf)for(var o in t.buf.attributes){s.add({prop:function(){}},"prop").name(o)}s.open()},t.set_src=function(e){t.properties.src=e,t.set_dirty()},t.get_meshes=function(){return[t.mesh]},t.parse_src=function(){if(t.properties.src){var e=F.get_src(t.properties.src);if(e)try{var n=JSON.parse(e);M(n),M(n.attributes);var i=new j;i.init(n.attributes,n.indices),t.mesh=i}catch(s){console.log(s),t.mesh=null}else t.properties.src=null}},t.update=function(){t.parse_src()},t.title="Vertex Buffer",t.properties={src:null},F.on_src_change((function(e){e==t.properties.src&&t.set_dirty()})),F.exec_after("remove_src",(function(e){e.src_name==t.properties.src&&t.set_src(null)})),t.buf={attributes:{}},t.set_dirty(),t.addOutput("mesh","mesh_t"),t}return Object(u.a)(e,t),e}(z),q=function(t){function e(){var t;return Object(o.a)(this,e),(t=Object(a.a)(this,Object(l.a)(e).call(this))).display=function(e){var n=[],i={src:t.properties.src};Object.keys(F.litegraph.config.srcs).forEach((function(t){return n.push(t)})),e.datgui.add(i,"src",n).onChange((function(e){return t.set_src(e)}))},t.set_src=function(e){t.properties.src=e,t.set_dirty()},t.get_buffer=function(e){return t.buf},t.parse_src=function(){if(t.properties.src){var e=F.get_src(t.properties.src);if(!e)return t.properties.src=null,void t.clean_outputs();try{var n=JSON.parse(e);M(n),M(n.data&&n.format&&n.width&&n.height);var i=new Set;i.add("uniform_t texture"),t.set_outputs(i),t.buf=n}catch(s){console.error("Error while parsing json"),console.error(s)}}else t.clean_outputs()},t.get_texture=function(e){return t.gl.texture},t.gl_init=function(e){var n=e.createTexture();t.gl={},t.gl.texture=n,e.bindTexture(e.TEXTURE_2D,n);var i=e.RGBA32F,s=t.buf.width,o=t.buf.height,r=e.RGBA,a=e.FLOAT,l=null;switch(t.buf.format){case"RGBA32F":a=e.FLOAT,i=e.RGBA32F,r=e.RGBA,l=new Float32Array(t.buf.data);break;case"RGBA32UI":a=e.UNSIGNED_INT,i=e.RGBA32UI,r=e.RGBA_INTEGER,l=new Uint32Array(t.buf.data);break;default:throw Error("Unsupported format. Please add!")}e.texImage2D(e.TEXTURE_2D,0,i,s,o,0,r,a,l),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)},t.gl_release=function(e){t.gl&&t.gl.texture&&e.deleteTexture(t.gl.texture),delete t.gl},t.update=function(){t.parse_src(),t.update_thumbnails(F.gl)},t.update_thumbnails=function(e){if(t.thumbnail=null,t.buf.data){t.gl_init(e);var n=F.get_texture_data(t.gl.texture,t.buf.format);t.gl_release(e);var i=document.createElement("canvas"),s=i.getContext("2d");i.width=n.width,i.height=n.height,s.putImageData(n,0,0);var o=document.createElement("img");o.src=i.toDataURL("image/png"),t.thumbnail=o,F.update_thumbnails()}},t.title="Texture Buffer",t.properties={src:null},t.properties={src:null},F.on_src_change((function(e){e==t.properties.src&&t.set_dirty()})),F.exec_after("remove_src",(function(e){e.src_name==t.properties.src&&t.set_src(null)})),t.buf={},t.thumbnail=null,t.set_dirty(),t}return Object(u.a)(e,t),Object(r.a)(e,[{key:"onDrawBackground",value:function(t){if(!this.flags.collapsed){var e=this.size[0]-32;this.thumbnail?t.drawImage(this.thumbnail,16,16,e,e):t.fillRect(16,16,e,e),this.size[1]=e+32}}}]),e}(z),Z=function(t){function e(){var t;return Object(o.a)(this,e),(t=Object(a.a)(this,Object(l.a)(e).call(this))).update_inputs=function(){var e=t.getInputNodeByName("pipeline"),n=new Set;if(e){var i=e.get_info();if(!i.valid)return;if(t.attributes=i.attributes,t.uniforms=i.uniforms,t.uniforms.forEach((function(t){return n.add("uniform_t "+t.name)})),t.properties.default_uniforms){var s=[];Object.keys(t.properties.default_uniforms).forEach((function(t){n.has("uniform_t "+t)||s.push(t)})),s.forEach((function(e){console.log("[INFO] Found stale default value for "+e),delete t.properties.default_uniforms[e]}))}}n.add("pipeline_t pipeline"),n.add("mesh_t mesh"),t.set_inputs(n)},t.gl_init=function(e){var n=t.getInputNodeByName("pipeline");if(null!=n){var i=t.getInputNodeByName("mesh");if(i)t.gl={},t.gl.arrays=[],t.gl.buffers=[],i.get_meshes().forEach((function(i){var s=e.createVertexArray();for(var o in t.gl.arrays.push(s),e.bindVertexArray(s),t.attributes){var r=t.attributes[o],a=i.get_attrib_data(r.name);if(a){M(a.type==r.type);var l=a.data,u=e.createBuffer();t.gl.buffers.push(u),e.bindBuffer(e.ARRAY_BUFFER,u),e.bufferData(e.ARRAY_BUFFER,new Float32Array(l),e.STATIC_DRAW);var h=n.get_attrib_location(e,r.name);if(!(h<0)){var c=-1;switch(r.type){case"vec2":c=2;break;case"vec3":c=3;break;default:throw Error("unrecognized type")}e.vertexAttribPointer(h,c,e.FLOAT,!1,0,0),e.enableVertexAttribArray(h)}}}s.draw_size=3;var p=i.get_index_data();M("data"in p);var d=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,d),t.gl.buffers.push(d),M("uint16"==p.type),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(p.data),e.STATIC_DRAW),s.draw_size=p.data.length,s.index_type=e.UNSIGNED_SHORT}))}},t.display=function(e){if(t.uniforms){var n={},i=e.datgui.addFolder("Uniforms"),s=function(e,s){var o=[".x",".y",".z",".w"];"default_uniforms"in t.properties||(t.properties.default_uniforms={}),e in t.properties.default_uniforms||(t.properties.default_uniforms[e]=[]),t.properties.default_uniforms[e].length!=s&&(t.properties.default_uniforms[e]=new Array(s).fill(0));for(var r=function(){var s=a;n[e+o[a]]=t.properties.default_uniforms[e][a],i.add(n,e+o[a]).step(.05).onChange((function(n){return t.properties.default_uniforms[e][s]=n}))},a=0;a<s;a++)r()};t.uniforms.forEach((function(t){switch(t.type){case"float":s(t.name,1);break;case"vec2":s(t.name,2);break;case"vec3":s(t.name,3)}})),i.open()}},t.gl_draw=function(e){var n=t.getInputNodeByName("pipeline");if(null!=n){n.bind(e);var i=0,s=n.get_uniform_location(e,"_resolution");if(s){var o=e.getParameter(e.VIEWPORT);e.uniform2fv(s,[o[2]-o[0],o[3]-o[1]])}for(var r in t.uniforms){var a=t.uniforms[r],l=n.get_uniform_location(e,a.name);if(l){var u=i;"texture"==a.type&&(e.activeTexture(e.TEXTURE0+u),e.bindTexture(e.TEXTURE_2D,null),e.uniform1i(l,u),i+=1);var h=t.getInputNodeByName(a.name);if(h){var c=t.getInputLinkByName(a.name);if("texture"==a.type){var p=h.get_texture(c.origin_slot);e.activeTexture(e.TEXTURE0+u),e.bindTexture(e.TEXTURE_2D,p),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.uniform1i(l,u)}else{var d=h.get_value(c.origin_slot);switch(a.type){case"int":e.uniform1i(l,d);break;default:throw Error("Unimplemented")}}}}}t.gl.arrays.forEach((function(t){e.bindVertexArray(t),e.drawElements(e.TRIANGLES,t.draw_size,t.index_type,0)}))}},t.gl_release=function(e){t.gl.buffers.forEach((function(t){return e.deleteBuffer(t)})),t.gl.arrays.forEach((function(t){return e.deleteVertexArray(t)})),delete t.gl},t.update=function(){t.update_inputs()},t.addOutput("out","drawcall_t"),t.addInput("pipeline","pipeline_t"),t.addInput("mesh","mesh_t"),t.title="Draw Call",t.attributes=[],t.uniforms=[],t.onConnectionsChange=function(e,n,i,s,o){t.set_dirty()},t}return Object(u.a)(e,t),Object(r.a)(e,[{key:"onSelected",value:function(){}},{key:"onDeselected",value:function(){}}]),e}(z),Q=function(t){function e(){var t;return Object(o.a)(this,e),(t=Object(a.a)(this,Object(l.a)(e).call(this))).reset=function(){var e=F.gl;t.gl.tex&&e.deleteTexture(t.gl.tex),t.gl.tex=e.createTexture(),e.bindTexture(e.TEXTURE_2D,t.gl.tex),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8,1,1)},t.is_recursive=function(){return!0},t.get_texture=function(){return t.gl.tex||t.reset(),t.gl.tex},t.gl_render=function(e){t.gl.tex&&e.deleteTexture(t.gl.tex),t.gl={tex:null};var n=t.getInputLinkByName("in");n&&(t.gl.tex=t.getInputNodeByName("in").clone_texture(n.origin_slot))},t.title="Feedback",t.addInput("in","uniform_t"),t.addOutput("out","uniform_t"),t.gl={tex:null},t.addWidget("button","reset",null,(function(e){t.reset()}),{}),t}return Object(u.a)(e,t),e}(z),$=function(t){function e(){var t;return Object(o.a)(this,e),(t=Object(a.a)(this,Object(l.a)(e).call(this))).gl_render=function(e){t.bind(e),t.inputs.forEach((function(t){if("drawcall_t"==t.type){var n=F.litegraph.links[t.link];if(!n)return;F.litegraph.getNodeById(n.origin_id).gl_draw(e)}})),t.update_thumbnails(e)},t.clear_outputs=function(){for(var e=t.outputs.length-1;e>=0;e--)t.removeOutput(e);t.properties.dc_cnt=0},t.update_outputs=function(){t.clear_outputs();for(var e=0;e<t.properties.rts.length;++e)t.addOutput("rt#"+e,"uniform_t");null!=t.properties.depth&&t.addOutput("depth","uniform_t")},t.push_rt=function(e){var n={};n.format=e.format,t.properties.rts.push(n),t.update_outputs()},t.pop_rt=function(){0!=t.properties.rts.length&&(t.properties.rts.pop(),t.update_outputs())},t.add_depth=function(e){if(null==t.properties.depth){var n={};n.format=e.format,t.properties.depth=n,t.update_outputs()}},t.remove_depth=function(){null!=t.properties.depth&&(t.properties.depth=null,t.update_outputs())},t.set_width=function(e){t.properties.viewport.width=e},t.set_height=function(e){t.properties.viewport.height=e},t.gl_init=function(e){t.gl={fb:null,rts:[]},t.gl.fb=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,t.gl.fb),M(0!=t.properties.rts.length||null!=t.properties.depth),t.draw_buffers=[],t.gl.rts=[];for(var n=0;n<t.properties.rts.length;++n){var i=t.gen_texture(e,n);t.gl.rts.push(i),t.draw_buffers.push(e.COLOR_ATTACHMENT0+n),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n,e.TEXTURE_2D,i,0)}if(null!=t.properties.depth){var s=t.gen_texture(e,t.properties.rts.length);t.gl.depth=s,e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,s,0)}var o=e.checkFramebufferStatus(e.DRAW_FRAMEBUFFER);if(o!=e.FRAMEBUFFER_COMPLETE)throw Error("fb status: "+o.toString(16))},t.clone_texture=function(e){var n=F.gl,i=t.properties.viewport.width,s=t.properties.viewport.height,o=t.gen_texture(n,e),r=t.get_texture(e),a=n.createFramebuffer();return n.bindFramebuffer(n.FRAMEBUFFER,a),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,o,0),n.disable(n.CULL_FACE),n.disable(n.DEPTH_TEST),n.disable(n.DEPTH_TEST),n.disable(n.SCISSOR_TEST),n.depthFunc(n.LEQUAL),n.blendFunc(n.ONE,n.ONE),n.bindFramebuffer(n.FRAMEBUFFER,a),n.drawBuffers([n.COLOR_ATTACHMENT0]),n.viewport(0,0,i,s),n.clearColor(0,0,1,1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),F.render_texture(r),n.deleteFramebuffer(a),o},t.gen_texture=function(e,n){if(n>=t.properties.rts.length){var i=t.properties.depth,s=e.createTexture();e.bindTexture(e.TEXTURE_2D,s);var o=null;switch(i.format){case"D16":o=e.DEPTH_COMPONENT16;break;case"D32":o=e.DEPTH_COMPONENT32F;break;default:throw Error("unknown format")}return e.texStorage2D(e.TEXTURE_2D,1,o,t.properties.viewport.width,t.properties.viewport.height),s}var r=t.properties.rts[n],a=e.createTexture();e.bindTexture(e.TEXTURE_2D,a);o=null;switch(r.format){case"RGBA8":o=e.RGBA8;break;case"RGBA32F":o=e.RGBA32F;break;default:throw Error("unknown format")}return e.texStorage2D(e.TEXTURE_2D,1,o,t.properties.viewport.width,t.properties.viewport.height),a},t.get_texture=function(e){return e>=t.properties.rts.length?t.gl.depth:t.gl.rts[e]},t.bind=function(e){e.bindFramebuffer(e.FRAMEBUFFER,t.gl.fb),e.drawBuffers(t.draw_buffers),e.viewport(0,0,t.properties.viewport.width,t.properties.viewport.height),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)},t.update_thumbnails=function(e){t.thumbnails=[];var n=Object(h.a)(t.gl.rts);for(var i in t.gl.depth&&n.push(t.gl.depth),n){var s=F.get_texture_data(n[i]),o=document.createElement("canvas"),r=o.getContext("2d");o.width=s.width,o.height=s.height,r.putImageData(s,0,0);var a=document.createElement("img");a.src=o.toDataURL("image/png"),a.onload=function(){F.update_thumbnails()},t.thumbnails.push(a)}t.gl.depth&&(t.depth_thumbnail=t.thumbnails[t.thumbnails.length-1]),F.update_thumbnails()},t.gl_release=function(e){if("gl"in Object(s.a)(t)){null!=t.gl.vfbs&&e.deleteFramebuffer(t.gl.fb);for(var n=0;n<t.gl.rts.length;++n){var i=t.gl.rts[n];e.deleteTexture(i)}t.gl.depth&&e.deleteTexture(t.gl.depth),delete t.gl}},t.display=function(e){var n={format:"RGBA8"},i={format:"D16"},o={width:t.properties.viewport.width,height:t.properties.viewport.height,push:function(){t.push_rt(n),e.clear_gui(),e.display_node(Object(s.a)(t))},pop:function(){t.pop_rt(),e.clear_gui(),e.display_node(Object(s.a)(t))},add_depth:function(){t.add_depth(i),e.clear_gui(),e.display_node(Object(s.a)(t))},remove_depth:function(){t.remove_depth(),e.clear_gui(),e.display_node(Object(s.a)(t))}},r=e.datgui.addFolder("Render targets");for(var a in t.properties.rts){var l={format:t.properties.rts[a].format};r.add(l,"format")}if(null!=t.properties.depth){var u={format:t.properties.depth.format};r.add(u,"format")}r.open();var h=e.datgui.addFolder("Add render target");h.add(n,"format",["RGBA8","RGBA32F"]),h.add(o,"push"),h.add(o,"pop"),h.open();var c=e.datgui.addFolder("Add depth target");c.add(i,"format",["D16","D32"]),c.add(o,"add_depth"),c.add(o,"remove_depth"),c.open();var p=e.datgui.addFolder("Viewport");p.add(o,"width",128,2048,16).onChange((function(e){return t.set_width(e)})),p.add(o,"height",128,2048,16).onChange((function(e){return t.set_height(e)})),p.open()},t.button=t.addWidget("button","Add DC",null,(function(e){t.addDC()}),{}),t.title="Pass",t.properties={viewport:{width:512,height:512},rts:[],depth:null,dc_cnt:0},t.yoffset=100,t.onPropertyChange=function(e,n){t.update_outputs()},t}return Object(u.a)(e,t),Object(r.a)(e,[{key:"onExecute",value:function(){}},{key:"onDrawBackground",value:function(t){if(!this.flags.collapsed){t.fillStyle="#000";var e=32+20*this.inputs.length,n=this.size[0]-32;for(var i in this.properties.rts)"thumbnails"in this&&i<this.thumbnails.length?t.drawImage(this.thumbnails[i],16,e,n,n):t.fillRect(16,e,n,n),e+=n+16;null!=this.properties.depth&&("depth_thumbnail"in this?t.drawImage(this.depth_thumbnail,16,e,n,n):t.fillRect(16,e,n,n),e+=n+16),this.size[1]=e,t.strokeStyle="#555"}}},{key:"addDC",value:function(){this.addInput("DC#"+this.properties.dc_cnt,"drawcall_t"),this.properties.dc_cnt+=1}},{key:"onMouseDown",value:function(t,e){}}]),e}(z),tt=function(t){function e(t,n){var i;return Object(o.a)(this,e),(i=Object(a.a)(this,Object(l.a)(e).call(this,t,n))).onResize=function(){var t=document.getElementById("tmp_canvas_container");F.litegraph_canvas.resize(t.offsetWidth,t.offsetHeight-70)},i.graph=F.litegraph,i.onResize=i.onResize.bind(Object(s.a)(i)),i.dumpJson=i.dumpJson.bind(Object(s.a)(i)),i}return Object(u.a)(e,t),Object(r.a)(e,[{key:"componentDidMount",value:function(){var t=this;F.litegraph_canvas=new D("#tmp_canvas",this.graph),F._selected_nodes={},F.litegraph_canvas.onSelectionChange=function(t){var e=[],n=[];for(var s in t){var o=t[s];o.id in F._selected_nodes||e.push(o)}for(var r in F._selected_nodes){var a=F._selected_nodes[r];a.id in t||n.push(a)}F._selected_nodes=Object(i.a)({},t),F.exec_selected(e),F.exec_deselected(n)},this.graph.start(),this.props.glContainer.on("resize",this.onResize),F.litegraph_canvas.resize(),R.registerNodeType("gfx/PassNode",$),R.registerNodeType("gfx/BackBufferNode",V),R.registerNodeType("gfx/DrawCallNode",Z),R.registerNodeType("gfx/PipelineNode",K),R.registerNodeType("gfx/VertexBufferNode",J),R.registerNodeType("gfx/ModelNode",W),R.registerNodeType("gfx/TextureBufferNode",q),R.registerNodeType("gfx/FeedbackNode",Q),R.registerNodeType("gfx/FrameCountNode",X),fetch("default_graph.json").then((function(t){return t.text()})).then((function(t){B(JSON.parse(t))})),this.onResize(),window.addEventListener("message",(function(e){try{var n=JSON.parse(e.data);if("type"in n)if("set(graph.json)"==n.type)B(JSON.parse(n.data));else if("get(graph.json)"==n.type){var i=t.graph.serialize(),s=JSON.stringify(i),o={};o.data=s,o.type="graph.json",window.parent!=window&&window.parent.postMessage(JSON.stringify(o),"*")}else console.log("unrecoginez command type: "+n.type);else console.log("unrecoginez command: "+e)}catch(r){}}))}},{key:"dumpJson",value:function(){var t=this.graph.serialize();!function(t){var e=document.createElement("textarea");e.style.position="fixed",e.style.top=0,e.style.left=0,e.style.width="2em",e.style.height="2em",e.style.padding=0,e.style.border="none",e.style.outline="none",e.style.boxShadow="none",e.style.background="transparent",e.value=t,document.body.appendChild(e),e.focus(),e.select();try{var n=document.execCommand("copy")?"successful":"unsuccessful";console.log("Copying text command was "+n)}catch(i){console.log("Oops, unable to copy")}document.body.removeChild(e)}(JSON.stringify(t))}},{key:"render",value:function(){return g.a.createElement("div",{style:{width:"100%",height:"100%"},id:"tmp_canvas_container"},g.a.createElement(b.a,{style:{margin:10},onClick:this.dumpJson},"Copy to clipboard"),g.a.createElement(b.a,{style:{margin:10},onClick:function(){console.log(F.litegraph_canvas.selected_nodes)}},"Dump Selected"),g.a.createElement(b.a,{variant:"danger",style:{margin:10},onClick:function(){F.exec_reset()}},"Clear"),g.a.createElement(b.a,{style:{margin:10},onClick:function(){F.draw()},variant:"success"},"Next Frame"),g.a.createElement(H,null),g.a.createElement("canvas",{id:"tmp_canvas",style:{border:"1px solid"}}))}}]),e}(g.a.Component),et=function(t){function e(t,n){var i;return Object(o.a)(this,e),(i=Object(a.a)(this,Object(l.a)(e).call(this,t,n))).setShow=function(t){i.setState({visible:t})},i.handleClose=function(){return i.setShow(!1)},i.handleShow=function(){return i.setShow(!0)},i.handleApply=function(){i.props.on_submit(i.myInput.value),i.setShow(!1)},i.state={visible:!1},i.myInput={value:""},i}return Object(u.a)(e,t),Object(r.a)(e,[{key:"render",value:function(){var t=this;return g.a.createElement(g.a.Fragment,null,g.a.createElement(b.a,{variant:"primary",onClick:this.handleShow},"New Source"),g.a.createElement(E.a,{show:this.state.visible,onHide:this.handleClose},g.a.createElement(E.a.Header,{closeButton:!0},g.a.createElement(E.a.Title,null,"Enter name")),g.a.createElement(C.a,{type:"text",placeholder:"source name",onChange:function(e){return t.myInput.value=e.target.value}}),g.a.createElement(E.a.Footer,null,g.a.createElement(b.a,{variant:"secondary",onClick:this.handleClose},"Cancel"),g.a.createElement(b.a,{variant:"primary",onClick:function(){return t.handleApply()}},"Create"))))}}]),e}(g.a.Component),nt=function(t){function e(t,n){var i;return Object(o.a)(this,e),(i=Object(a.a)(this,Object(l.a)(e).call(this,t,n))).rebuildGui=function(){i.datgui=new y.a({autoPlace:!1}),i.src_list=[],i.datgui_state={select_src:i.selected_src,remove_src:function(){i.remove_src()}},"srcs"in F.litegraph.config&&Object.keys(F.litegraph.config.srcs).forEach((function(t){return i.src_list.push(t)})),i.datgui.src_list=i.datgui.add(i.datgui_state,"select_src",i.src_list).onChange((function(t){return i.edit_src(t)})),i.datgui.add(i.datgui_state,"remove_src");for(var t=document.getElementById("teditor_gui_container"),e=t.lastElementChild;e;)t.removeChild(e),e=t.lastElementChild;t.appendChild(i.datgui.domElement)},i.edit_src=function(t){if(null==t)return i.selected_src=null,void i.refs.editor.editor.setValue("");M(t in F.litegraph.config.srcs),i.selected_src=t,i.refs.editor.editor.setValue(F.litegraph.config.srcs[t].code),i.refs.editor.editor.setOptions({fontSize:"8pt"}),i.refs.editor.editor.setAutoScrollEditorIntoView(!0),i.refs.editor.editor.getSession().setOptions({tabSize:2,useSoftTabs:!0,navigateWithinSoftTabs:!0})},i.add_src=function(t){F.exec({type:"add_src",src_name:t}),i.edit_src(t),i.rebuildGui()},i.remove_src=function(){null!=i.selected_src&&F.exec({type:"remove_src",src_name:i.selected_src})},i.onChange=i.onChange.bind(Object(s.a)(i)),i.onResize=i.onResize.bind(Object(s.a)(i)),i.selected_src=null,F.exec_after("remove_src",(function(t){t.src_name==i.selected_src&&(i.edit_src(null),i.rebuildGui())})),F.on_reset((function(){i.edit_src(null),i.rebuildGui()})),i}return Object(u.a)(e,t),Object(r.a)(e,[{key:"componentDidMount",value:function(){this.props.glContainer.on("resize",this.onResize),this.edit_src(null),this.rebuildGui()}},{key:"onChange",value:function(t){null!=this.selected_src&&F.set_src(this.selected_src,t)}},{key:"onResize",value:function(){this.refs.editor.editor.resize()}},{key:"render",value:function(){var t=this;return g.a.createElement("div",{className:"ace_editor_container"},g.a.createElement(et,{on_submit:function(e){return t.add_src(e)}}),g.a.createElement("div",{id:"teditor_gui_container"}),g.a.createElement(m.a,{value:this.text,ref:"editor",mode:"glsl",theme:"tomorrow_night_eighties",onChange:this.onChange,name:"UNIQUE_ID_OF_DIV",editorProps:{$blockScrolling:!0},enableBasicAutocompletion:!0,enableLiveAutocompletion:!0,autoScrollEditorIntoView:!1,wrapEnabled:!1,height:"calc(100% - 100px)",width:"calc(100%)"}))}}]),e}(g.a.Component),it=function(t){function e(t,n){var i;return Object(o.a)(this,e),(i=Object(a.a)(this,Object(l.a)(e).call(this,t,n))).subscribe=function(t){i.subscribers.add(t)},i.unsubscribe=function(t){i.subscribers.delete(t)},i.notify=function(){i.subscribers.forEach((function(t){t.set_dirty&&t.set_dirty()}))},i.set_dirty=function(){F.set_dirty(Object(s.a)(i))},i.update=function(){i.clear_gui(),i.display_node(i.selected_node)},i.clear_gui=function(){for(var t=document.getElementById("PropertiesNodeWrapper"),e=t.lastElementChild;e;)t.removeChild(e),e=t.lastElementChild},i.display_node=function(t){null!=t&&(i.datgui=new y.a({autoPlace:!1}),"display"in t&&t.display(Object(s.a)(i)),document.getElementById("PropertiesNodeWrapper").appendChild(i.datgui.domElement))},i.selected_node=null,F.exec_on_select((function(t){i.selected_node=t,i.display_node(t),t.subscribe(Object(s.a)(i))}),(function(t){i.selected_node==t&&(i.selected_node=null,i.clear_gui(),t.unsubscribe(Object(s.a)(i)))})),F.exec_after("remove_src",(function(t){i.clear_gui(),i.display_node(i.selected_node)})),F.exec_after("add_src",(function(t){i.clear_gui(),i.display_node(i.selected_node)})),F.on_reset((function(){i.clear_gui()})),i.subscribers=new Set,i}return Object(u.a)(e,t),Object(r.a)(e,[{key:"componentDidMount",value:function(){}},{key:"render",value:function(){return g.a.createElement("div",{id:"PropertiesNodeWrapper"})}}]),e}(g.a.Component),st=function(t){function e(t,n){return Object(o.a)(this,e),Object(a.a)(this,Object(l.a)(e).call(this,t,n))}return Object(u.a)(e,t),Object(r.a)(e,[{key:"componentDidMount",value:function(){var t=this;this.globals={};var e={content:[{type:"row",content:[{type:"column",content:[{type:"react-component",isClosable:!1,component:"TextEditor",title:"Text Editor",props:{globals:function(){return t.globals}}},{type:"stack",width:84,height:40,content:[{type:"react-component",isClosable:!1,component:"PropertiesNode",title:"Properties",props:{globals:function(){return t.globals}}},{type:"react-component",isClosable:!1,component:"GLW",title:"Back Buffer",props:{globals:function(){return t.globals}}}]}]},{type:"react-component",isClosable:!1,component:"Graphs",title:"Graphs",props:{globals:function(){return t.globals}},width:145}]}]},n=new p.a(e,this.layout);this.layout=n,n.registerComponent("Graphs",tt),n.registerComponent("GLW",Y),n.registerComponent("TextEditor",nt),n.registerComponent("PropertiesNode",it),n.init(),window.React=g.a,window.ReactDOM=f.a,window.addEventListener("resize",(function(){n.updateSize()}))}},{key:"render",value:function(){var t=this;return g.a.createElement("div",{className:"goldenLayout",ref:function(e){return t.layout=e}})}}]),e}(g.a.Component);f.a.render(g.a.createElement(st,null),document.getElementById("root"))}},[[55,1,2]]]);
//# sourceMappingURL=main.966d38bd.chunk.js.map